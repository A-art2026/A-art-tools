<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A_art Planner | نسخه کامل و پایدار</title>
    
    <!-- فونت‌ها: وزیرمتن (فارسی) و لکسند (انگلیسی) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;700&family=Vazirmatn:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <!-- کتابخانه پردازش PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // تنظیم ورکر برای PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <style>
        /* --- 1. متغیرهای طراحی (تم نئونی) --- */
        :root {
            --bg-body: #050505;
            --bg-card: #141414;
            --bg-modal: #1a1a1a;
            --bg-input: #0a0a0a;
            --accent: #ccff00; /* سبز نئونی */
            --accent-dim: rgba(204, 255, 0, 0.15);
            --text-main: #f0f0f0;
            --text-muted: #888888;
            --border: #333333;
            --radius: 12px;
            --font-fa: 'Vazirmatn', sans-serif;
            --font-en: 'Lexend', sans-serif;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: var(--font-fa);
            margin: 0; padding: 0;
            min-height: 100vh;
            overflow-x: hidden;
            padding-bottom: 100px;
        }

        /* پس‌زمینه متحرک (Aura) */
        #aura {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none;
            background: radial-gradient(circle at 50% 30%, rgba(204,255,0,0.04), transparent 70%);
            animation: pulse 8s infinite alternate;
        }
        @keyframes pulse { 0% { transform: scale(1); opacity: 0.5; } 100% { transform: scale(1.1); opacity: 0.8; } }

        /* تایپوگرافی */
        h1, h2, h3, h4 { color: #fff; font-weight: 700; margin: 0 0 15px 0; }
        .font-en { font-family: var(--font-en); direction: ltr; text-align: left; }
        .text-accent { color: var(--accent); }
        .text-muted { color: var(--text-muted); font-size: 0.85rem; }

        /* چیدمان */
        .container { max-width: 950px; margin: 0 auto; padding: 20px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .flex { display: flex; } 
        .justify-between { justify-content: space-between; } 
        .items-center { align-items: center; }
        .w-full { width: 100%; }
        .mt-4 { margin-top: 16px; }
        .hidden { display: none !important; }

        /* کارت‌ها و ورودی‌ها */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 20px;
            transition: border-color 0.2s;
        }
        .card:hover { border-color: #444; }
        
        label { display: block; margin-bottom: 8px; font-size: 0.9rem; color: var(--text-muted); }
        
        input, select, textarea {
            width: 100%;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: #fff;
            padding: 12px 16px;
            border-radius: 8px;
            font-family: var(--font-fa);
            font-size: 0.95rem;
            margin-bottom: 15px;
            transition: 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent-dim);
        }

        /* دکمه‌ها */
        .btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-family: var(--font-fa);
            font-size: 0.9rem;
            transition: 0.2s;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:hover { border-color: var(--accent); color: var(--accent); }
        .btn-primary {
            background: var(--accent);
            color: #000;
            border: none;
            font-weight: 700;
        }
        .btn-primary:hover {
            background: #b3e600;
            transform: translateY(-2px);
            box-shadow: 0 4px 20px var(--accent-dim);
        }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
        
        .btn-close-icon {
            background: rgba(255,255,255,0.1);
            border: none;
            color: #fff;
            width: 32px; height: 32px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
        }
        .btn-close-icon:hover { background: #ff3333; }

        /* هدر */
        header {
            background: rgba(5,5,5,0.9);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            padding: 15px 0;
            position: sticky; top: 0; z-index: 100;
            margin-bottom: 30px;
        }
        .logo { font-family: var(--font-en); font-weight: 900; font-size: 1.4rem; letter-spacing: -1px; }
        .flicker { animation: flick 4s infinite; color: var(--accent); }
        @keyframes flick { 0%,100%{opacity:1} 95%{opacity:0.8} 96%{opacity:0.2} 97%{opacity:1} }

        .nav-link {
            background: none; border: none; color: var(--text-muted);
            cursor: pointer; margin-left: 15px; font-size: 0.9rem; font-family: var(--font-fa);
            padding: 6px 12px; border-radius: 6px; transition: 0.3s;
        }
        .nav-link.active { color: var(--accent); background: rgba(255,255,255,0.05); }

        /* مودال (اصلاح شده) */
        dialog {
            background: var(--bg-modal);
            color: var(--text-main);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 90%; max-width: 600px;
            padding: 0;
            box-shadow: 0 20px 60px rgba(0,0,0,0.9);
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 1000;
        }
        dialog::backdrop { background: rgba(0,0,0,0.85); backdrop-filter: blur(4px); }
        
        .modal-header { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.03); }
        .modal-body { padding: 20px; max-height: 70vh; overflow-y: auto; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; background: rgba(0,0,0,0.2); }

        /* تب‌ها */
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; background: #222; padding: 4px; border-radius: 8px; }
        .tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; border-radius: 6px; font-size: 0.9rem; color: #888; }
        .tab.active { background: var(--accent); color: #000; font-weight: bold; }

        /* استپ‌های ویزارد */
        .step-indicator { display: flex; gap: 5px; margin-bottom: 20px; }
        .step-dot { flex: 1; height: 4px; background: #333; border-radius: 2px; transition: 0.3s; }
        .step-dot.active { background: var(--accent); box-shadow: 0 0 5px var(--accent); }

        @media (max-width: 768px) { .grid-2, .grid-3 { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div id="aura"></div>

    <!-- 1. مودال تنظیمات (کامل و فیکس شده) -->
    <dialog id="settings-modal">
        <div class="modal-header">
            <h3>تنظیمات هوش مصنوعی (API)</h3>
            <button class="btn-close-icon" onclick="document.getElementById('settings-modal').close()">✕</button>
        </div>
        
        <div class="modal-body">
            <div class="tabs">
                <div class="tab active" id="t-gemini" onclick="app.setTab('gemini')">Google Gemini</div>
                <div class="tab" id="t-openai" onclick="app.setTab('openai')">Metis / OpenAI</div>
            </div>

            <!-- تنظیمات جمنای -->
            <div id="conf-gemini">
                <p class="text-muted" style="font-size:0.85rem">اتصال مستقیم به سرورهای گوگل (نیاز به تغییر IP).</p>
                <label>API Key</label>
                <input type="password" id="gemini-key" class="font-en" placeholder="AIzaSy...">
                
                <label>مدل (Model)</label>
                <input list="gemini-list" id="gemini-model" class="font-en" placeholder="نام مدل را انتخاب یا تایپ کنید...">
                <datalist id="gemini-list">
                    <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (جدید)</option>
                    <option value="gemini-1.5-flash">Gemini 1.5 Flash (سریع)</option>
                    <option value="gemini-1.5-pro">Gemini 1.5 Pro (قدرتمند)</option>
                </datalist>
            </div>

            <!-- تنظیمات متیس / اوپن‌ای‌آی -->
            <div id="conf-openai" class="hidden">
                <p class="text-muted" style="font-size:0.85rem">اتصال به MetisAI یا سرویس‌های مشابه (بدون تحریم).</p>
                <label>Base URL (آدرس سرور)</label>
                <input type="text" id="custom-url" class="font-en" placeholder="https://api.metisai.ir/openai/v1">
                <p style="font-size:0.75rem; color:#666; margin-top:-10px; margin-bottom:10px">مثال متیس: <code>https://api.metisai.ir/openai/v1</code></p>
                
                <label>API Key</label>
                <input type="password" id="custom-key" class="font-en" placeholder="sk-...">
                
                <label>Model Name (نام دقیق مدل)</label>
                <input type="text" id="custom-model" class="font-en" placeholder="gpt-4o-mini">
            </div>

            <!-- باکس تست اتصال -->
            <div style="margin-top:20px; padding:15px; background:rgba(255,255,255,0.05); border-radius:8px; border:1px solid #333;">
                <div class="flex justify-between items-center">
                    <span style="font-size:0.85rem">وضعیت اتصال:</span>
                    <span id="conn-status" class="font-en" style="font-size:0.8rem; color:#aaa; font-weight:bold">آزمایش نشده</span>
                </div>
                <button class="btn btn-sm w-full mt-4" onclick="app.testConn()">تست اتصال (Ping)</button>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn" onclick="document.getElementById('settings-modal').close()">انصراف</button>
            <button class="btn btn-primary" onclick="app.saveSettings()">ذخیره و اعمال</button>
        </div>
    </dialog>

    <!-- 2. هدر سایت -->
    <header>
        <div class="container flex justify-between items-center">
            <div class="logo"><span class="flicker">A_art</span> Planner</div>
            <nav>
                <button class="nav-link active" onclick="app.nav('home')">پروژه‌ها</button>
                <button class="nav-link" onclick="app.nav('briefs')">بریف‌ها</button>
                <button class="nav-link" onclick="app.nav('brain')">مغز متفکر</button>
                <button class="nav-link" onclick="document.getElementById('settings-modal').showModal()">⚙️ API</button>
            </nav>
        </div>
    </header>

    <!-- 3. کانتینر اصلی -->
    <main id="root" class="container"></main>

    <!-- 4. منطق برنامه (Javascript) -->
    <script>
        // --- داده‌های پایه: فریم‌ورک‌های محتوایی ---
        const FRAMEWORKS = {
            'AIDA': {
                name: 'AIDA (فروش کلاسیک)',
                desc: 'مدل کلاسیک برای جلب توجه و هدایت به خرید.',
                fields: [
                    {id:'att', label:'Attention (توجه)', hint:'تیتر یا قلاب ۳ ثانیه‌ای برای توقف اسکرول'},
                    {id:'int', label:'Interest (علاقه)', hint:'اطلاعات جذاب و مرتبط با نیاز مخاطب'},
                    {id:'des', label:'Desire (تمایل)', hint:'ایجاد اشتیاق با ذکر مزایا و اثبات'},
                    {id:'act', label:'Action (اقدام)', hint:'دعوت به اقدام (CTA) شفاف و صریح'}
                ]
            },
            'PAS': {
                name: 'PAS (حل درد)',
                desc: 'دست گذاشتن روی مشکل و ارائه راه حل.',
                fields: [
                    {id:'prob', label:'Problem (مشکل)', hint:'بیان شفاف درد یا چالش اصلی مخاطب'},
                    {id:'agi', label:'Agitate (تشدید)', hint:'تشریح عواقب حل نکردن مشکل (نمک روی زخم)'},
                    {id:'sol', label:'Solution (راه‌حل)', hint:'معرفی محصول شما به عنوان راه نجات'}
                ]
            },
            'StoryBrand': {
                name: 'StoryBrand (داستانی)',
                desc: 'سفر قهرمان (مشتری) با راهنمایی شما.',
                fields: [
                    {id:'char', label:'شخصیت (قهرمان)', hint:'مشتری چه چیزی می‌خواهد؟'},
                    {id:'prob', label:'مشکل', hint:'چه مانعی سر راه اوست؟'},
                    {id:'guide', label:'راهنما (برند)', hint:'همدلی و صلاحیت خود را نشان دهید'},
                    {id:'plan', label:'نقشه راه', hint:'مراحل ساده استفاده از محصول'},
                    {id:'cta', label:'CTA', hint:'دعوت به خرید یا ثبت‌نام'},
                    {id:'res', label:'موفقیت', hint:'تصویر زندگی ایده‌آل بعد از خرید'}
                ]
            }
        };

        // --- کالس اصلی برنامه ---
        class App {
            constructor() {
                // وضعیت اولیه (State)
                this.state = {
                    view: 'home',
                    // بازیابی داده‌ها از حافظه
                    projects: JSON.parse(localStorage.getItem('avp_projects') || '[]'),
                    briefs: JSON.parse(localStorage.getItem('avp_briefs') || '[]'),
                    brain: JSON.parse(localStorage.getItem('avp_brain') || '[]'),
                    
                    // تنظیمات پیش‌فرض API
                    provider: localStorage.getItem('avp_provider') || 'gemini',
                    
                    geminiKey: localStorage.getItem('avp_gemini_key') || '',
                    geminiModel: localStorage.getItem('avp_gemini_model') || 'gemini-1.5-flash',
                    
                    customUrl: localStorage.getItem('avp_custom_url') || 'https://api.metisai.ir/openai/v1',
                    customKey: localStorage.getItem('avp_custom_key') || '',
                    customModel: localStorage.getItem('avp_custom_model') || 'gpt-4o-mini',

                    // متغیرهای موقت
                    activeProj: null,
                    activeBrief: null,
                    step: 1,
                    temp: {},
                    loading: false
                };

                // پر کردن فیلدهای تنظیمات هنگام لود شدن
                setTimeout(() => {
                    document.getElementById('gemini-key').value = this.state.geminiKey;
                    document.getElementById('gemini-model').value = this.state.geminiModel;
                    document.getElementById('custom-url').value = this.state.customUrl;
                    document.getElementById('custom-key').value = this.state.customKey;
                    document.getElementById('custom-model').value = this.state.customModel;
                    this.setTab(this.state.provider);
                }, 100);

                // اگر کلید نداریم، مودال باز شود
                if(!this.state.geminiKey && !this.state.customKey) {
                    setTimeout(() => document.getElementById('settings-modal').showModal(), 1000);
                }

                this.render();
            }

            // --- مدیریت تنظیمات ---
            setTab(p) {
                this.state.provider = p;
                document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
                document.getElementById('t-'+p).classList.add('active');
                
                document.getElementById('conf-gemini').classList.add('hidden');
                document.getElementById('conf-openai').classList.add('hidden');
                document.getElementById('conf-'+p).classList.remove('hidden');
            }

            saveSettings() {
                this.state.geminiKey = document.getElementById('gemini-key').value.trim();
                this.state.geminiModel = document.getElementById('gemini-model').value.trim();
                this.state.customUrl = document.getElementById('custom-url').value.trim();
                this.state.customKey = document.getElementById('custom-key').value.trim();
                this.state.customModel = document.getElementById('custom-model').value.trim();

                localStorage.setItem('avp_provider', this.state.provider);
                localStorage.setItem('avp_gemini_key', this.state.geminiKey);
                localStorage.setItem('avp_gemini_model', this.state.geminiModel);
                localStorage.setItem('avp_custom_url', this.state.customUrl);
                localStorage.setItem('avp_custom_key', this.state.customKey);
                localStorage.setItem('avp_custom_model', this.state.customModel);

                document.getElementById('settings-modal').close();
                alert('تنظیمات با موفقیت ذخیره شد.');
            }

            async testConn() {
                const s = document.getElementById('conn-status');
                s.innerText = 'درحال اتصال...'; s.style.color = '#ffcc00';
                try {
                    const res = await this.callAI("فقط بگو: OK", false);
                    if(res.startsWith("ERR")) throw new Error(res);
                    s.innerText = 'متصل شد ✅'; s.style.color = '#00ff66';
                } catch(e) {
                    s.innerText = 'خطا: ' + e.message; s.style.color = '#ff3333';
                }
            }

            // --- مسیریابی (Navigation) ---
            nav(view, id = null) {
                this.state.view = view;
                // آپدیت کلاس اکتیو منو
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                const map = {'home':0, 'briefs':1, 'brain':2};
                if(map[view] !== undefined) document.querySelectorAll('.nav-link')[map[view]].classList.add('active');

                // اگر وارد ویزارد پروژه شدیم
                if (view === 'wizard') {
                    const p = this.state.projects.find(x => x.id === id);
                    this.state.activeProj = p;
                    // پیدا کردن بریف مربوطه
                    this.state.activeBrief = this.state.briefs.find(b => b.id === p.briefId) || this.state.briefs[0];
                    this.state.temp = { ...p.data };
                    this.state.step = 1;
                }
                this.render();
            }

            // --- رندرینگ صفحات (Views) ---
            render() {
                const root = document.getElementById('root');
                root.innerHTML = '';
                switch(this.state.view) {
                    case 'home': root.innerHTML = this.viewHome(); break;
                    case 'briefs': root.innerHTML = this.viewBriefs(); break;
                    case 'brain': root.innerHTML = this.viewBrain(); break;
                    case 'setup': root.innerHTML = this.viewSetup(); break;
                    case 'wizard': this.renderWizard(root); break;
                }
            }

            // 1. صفحه خانه
            viewHome() {
                return `
                    <div class="flex justify-between items-center mb-4">
                        <h2>داشبورد پروژه‌ها</h2>
                        <button class="btn btn-primary" onclick="app.nav('setup')">+ پروژه جدید</button>
                    </div>
                    <div class="grid-3">
                        ${this.state.projects.map(p => {
                            const b = this.state.briefs.find(x=>x.id===p.briefId);
                            return `
                            <div class="card" onclick="app.nav('wizard','${p.id}')" style="cursor:pointer">
                                <h3>${p.name}</h3>
                                <p class="text-muted" style="margin:10px 0">بریف: <span class="text-accent">${b?b.name:'نامشخص'}</span></p>
                                <button class="btn btn-sm" onclick="event.stopPropagation();app.delProj('${p.id}')">حذف پروژه</button>
                            </div>`
                        }).join('')}
                    </div>
                    ${this.state.projects.length===0 ? '<div class="text-center text-muted mt-4">هنوز پروژه‌ای ندارید.</div>' : ''}
                `;
            }

            // 2. صفحه بریف‌ها
            viewBriefs() {
                return `
                    <div class="card" style="border-top:4px solid var(--accent)">
                        <h2>ساخت بریف جدید</h2>
                        <p class="text-muted">اطلاعات کسب‌وکار خود را وارد کنید تا هوش مصنوعی آن را بشناسد.</p>
                        <div class="grid-2">
                            <div><label>نام برند</label><input id="bf-name" placeholder="مثلا: فروشگاه کفش البرز"></div>
                            <div><label>لحن برند (Tone)</label><input id="bf-tone" placeholder="دوستانه، رسمی، پرانرژی..."></div>
                        </div>
                        <label>توضیحات کوتاه (ما چه می‌کنیم؟)</label><textarea id="bf-desc" rows="2"></textarea>
                        <label>مخاطب هدف (پرسونا)</label><textarea id="bf-aud" rows="2" placeholder="جوانان ۱۸ تا ۲۵ سال..."></textarea>
                        <button class="btn btn-primary w-full" onclick="app.addBrief()">ایجاد بریف</button>
                    </div>
                    
                    <h3>بریف‌های ذخیره شده</h3>
                    <div class="grid-3">
                        ${this.state.briefs.map(b => `
                            <div class="card">
                                <h3 class="text-accent">${b.name}</h3>
                                <p class="text-muted" style="font-size:0.8rem; margin-bottom:15px">${b.desc}</p>
                                <button class="btn btn-sm w-full" onclick="app.delBrief('${b.id}')">حذف</button>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // 3. صفحه مغز متفکر (PDF)
            viewBrain() {
                return `
                    <div class="card">
                        <h2>مغز متفکر (پایگاه دانش)</h2>
                        <p class="text-muted">فایل‌های آموزشی یا اطلاعات محصول (PDF/TXT) را اینجا آپلود کنید.</p>
                        <div class="grid-2">
                            <div>
                                <label>عنوان فایل</label><input id="br-title" placeholder="مثلا: کاتالوگ پاییز">
                                <label>آپلود فایل</label>
                                <input type="file" onchange="app.handleFile(event)" accept=".pdf,.txt,.md,.json">
                                ${this.state.loading ? '<span class="flicker text-accent">درحال پردازش فایل...</span>' : ''}
                            </div>
                            <div>
                                <label>متن استخراج شده</label><textarea id="br-text" rows="6" placeholder="متن فایل اینجا نمایش داده می‌شود..."></textarea>
                                <button class="btn btn-primary w-full" onclick="app.addBrain()">افزودن به مغز</button>
                            </div>
                        </div>
                    </div>
                    
                    <h3>منابع دانش فعال</h3>
                    <div class="grid-3">
                        ${this.state.brain.map(b => `<div class="card"><strong>${b.title}</strong><br><button class="btn btn-sm mt-2 w-full" onclick="app.delBrain('${b.id}')">حذف</button></div>`).join('')}
                    </div>
                `;
            }

            // 4. صفحه انتخاب بریف برای پروژه جدید
            viewSetup() {
                if(this.state.briefs.length === 0) return '<div class="text-center" style="padding-top:50px"><h2>ابتدا یک بریف بسازید</h2><button class="btn btn-primary mt-4" onclick="app.nav(\'briefs\')">ساخت بریف</button></div>';
                
                return `
                    <h2>شروع پروژه جدید: انتخاب بریف</h2>
                    <div class="grid-3 mb-4">
                        ${this.state.briefs.map(b => `
                            <div class="card" id="br-${b.id}" onclick="app.selBr('${b.id}')" style="cursor:pointer; border:2px solid transparent; background:#1a1a1a">
                                <strong>${b.name}</strong>
                                <p style="font-size:0.8rem; color:#666">${b.desc}</p>
                            </div>
                        `).join('')}
                    </div>
                    <div class="card">
                        <label>نام پروژه</label><input id="np-name" placeholder="مثلا: کمپین بلک فرایدی">
                        <button class="btn btn-primary w-full" onclick="app.createProj()">ایجاد پروژه</button>
                    </div>
                `;
            }
            
            selBr(id) {
                document.querySelectorAll('[id^="br-"]').forEach(e => {
                    e.style.borderColor = 'transparent';
                    e.style.backgroundColor = '#1a1a1a';
                });
                const el = document.getElementById('br-'+id);
                el.style.borderColor = 'var(--accent)';
                el.style.backgroundColor = 'var(--bg-card)';
                this.state.selBrId = id;
            }

            // --- ویزارد اصلی (مراحل ۵گانه) ---
            renderWizard(root) {
                const s = this.state.step;
                const d = this.state.temp;
                let content = '';

                // مرحله ۱: هدف
                if(s === 1) {
                    content = `
                        <h3>هدف و پیام</h3>
                        <div class="grid-2">
                            <div>
                                <label>هدف اصلی</label>
                                <select id="i-obj" onchange="app.setD('obj',this.value)">
                                    <option value="Awareness" ${d.obj=='Awareness'?'selected':''}>آگاهی (Awareness)</option>
                                    <option value="Sales" ${d.obj=='Sales'?'selected':''}>فروش (Sales)</option>
                                    <option value="Engagement" ${d.obj=='Engagement'?'selected':''}>تعامل (Engagement)</option>
                                </select>
                            </div>
                            <div>
                                <label>موضوع این پست</label>
                                <input value="${d.topic||''}" onchange="app.setD('topic',this.value)" placeholder="مثلا: تخفیف ۵۰ درصدی">
                            </div>
                        </div>
                        <label>پیام کلیدی / آفر</label>
                        <textarea rows="3" onchange="app.setD('msg',this.value)" placeholder="چه چیزی می‌خواهید بگویید؟">${d.msg||''}</textarea>
                    `;
                } 
                // مرحله ۲: قالب
                else if(s === 2) {
                    let rec = 'AIDA'; // پیش‌فرض
                    if(d.obj === 'Sales') rec = 'PAS';
                    if(d.obj === 'Engagement') rec = 'StoryBrand';
                    if(!d.tmpl) d.tmpl = rec;

                    content = `
                        <h3>انتخاب قالب محتوا</h3>
                        <div style="background:#222; padding:10px; border-radius:8px; border:1px solid var(--accent); margin-bottom:15px">
                            پیشنهاد هوش مصنوعی: <strong class="text-accent">${rec}</strong>
                        </div>
                        <label>قالب:</label>
                        <select id="i-tmpl" onchange="app.setD('tmpl',this.value); app.render()">
                            ${Object.keys(FRAMEWORKS).map(k => `<option value="${k}" ${d.tmpl==k?'selected':''}>${FRAMEWORKS[k].name}</option>`).join('')}
                        </select>
                        <p class="text-muted mt-4">${FRAMEWORKS[d.tmpl].desc}</p>
                    `;
                }
                // مرحله ۳: تولید محتوا
                else if(s === 3) {
                    const f = FRAMEWORKS[d.tmpl].fields;
                    content = `
                        <h3>تولید محتوا (${d.tmpl})</h3>
                        <button class="btn btn-sm mb-4" onclick="app.autoFill()" style="color:var(--accent); border:1px solid var(--accent)">✨ تکمیل خودکار با AI</button>
                        
                        <div id="f-cont">
                            ${f.map(x => `
                                <div class="mb-4">
                                    <label class="text-accent">${x.label}</label>
                                    <p class="text-muted" style="font-size:0.8rem; margin-bottom:5px">${x.hint}</p>
                                    <textarea rows="3" onchange="app.setCF('${x.id}',this.value)">${(d.cf && d.cf[x.id]) || ''}</textarea>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                // مرحله ۴: تحلیل
                else if(s === 4) {
                    content = `
                        <h3>آنالیز هوشمند</h3>
                        <p class="text-muted">بررسی نقاط قوت و ضعف متن شما توسط AI.</p>
                        <button class="btn btn-primary w-full" id="b-anlz" onclick="app.analyze()">شروع تحلیل</button>
                        <div id="r-anlz" class="card mt-4 hidden" style="white-space:pre-wrap; line-height:1.7"></div>
                    `;
                }
                // مرحله ۵: خروجی
                else if(s === 5) {
                    let txt = `استراتژی: ${d.tmpl}\n\n`;
                    if(d.cf) Object.values(d.cf).forEach(v => txt += v + "\n\n");
                    
                    content = `
                        <h3>خروجی نهایی</h3>
                        <div class="grid-2">
                            <div>
                                <label>سناریو کامل</label>
                                <textarea rows="12" id="ftxt">${txt}</textarea>
                            </div>
                            <div>
                                <label>کپشن و هشتگ</label>
                                <button class="btn btn-primary w-full mb-2" id="b-cap" onclick="app.caption()">تولید کپشن</button>
                                <textarea rows="9" id="fcap">${d.cap||''}</textarea>
                            </div>
                        </div>
                    `;
                }

                // فریم کلی ویزارد
                root.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <button class="btn" onclick="app.nav('home')">خروج</button>
                        <span>${this.state.activeProj.name}</span>
                    </div>
                    <div style="display:flex; gap:5px; margin-bottom:20px">
                        ${[1,2,3,4,5].map(i => `<div style="flex:1; height:4px; border-radius:2px; background:${i<=s ? 'var(--accent)' : '#333'}"></div>`).join('')}
                    </div>
                    
                    <div class="card" style="min-height:400px">${content}</div>
                    
                    <div class="flex justify-between">
                        <button class="btn" onclick="app.step(-1)" ${s==1?'disabled':''}>مرحله قبل</button>
                        <button class="btn btn-primary" onclick="app.step(1)">${s==5?'پایان و ذخیره':'مرحله بعد'}</button>
                    </div>
                `;
            }

            // --- توابع کمکی ---
            addBrief() {
                const n = document.getElementById('bf-name').value;
                if(n) {
                    this.state.briefs.push({
                        id: Date.now().toString(),
                        name: n,
                        desc: document.getElementById('bf-desc').value,
                        aud: document.getElementById('bf-aud').value,
                        tone: document.getElementById('bf-tone').value
                    });
                    this.saveStores();
                    this.render();
                } else { alert('نام برند الزامی است'); }
            }
            delBrief(id) { this.state.briefs = this.state.briefs.filter(b=>b.id!==id); this.saveStores(); this.render(); }
            
            async handleFile(e) {
                const f = e.target.files[0];
                if(!f) return;
                this.state.loading = true;
                this.render();
                
                try {
                    let t = "";
                    if(f.type === 'application/pdf') {
                        const a = await f.arrayBuffer();
                        const p = await pdfjsLib.getDocument(a).promise;
                        for(let i=1; i<=p.numPages; i++) {
                            const g = await p.getPage(i);
                            const c = await g.getTextContent();
                            t += c.items.map(s => s.str).join(' ') + '\n';
                        }
                    } else {
                        t = await f.text();
                    }
                    document.getElementById('br-text').value = t;
                    if(!document.getElementById('br-title').value) document.getElementById('br-title').value = f.name;
                } catch(err) { alert('خطا در خواندن فایل'); }
                
                this.state.loading = false;
                this.render();
            }
            
            addBrain() {
                const t = document.getElementById('br-title').value;
                const c = document.getElementById('br-text').value;
                if(t && c) {
                    this.state.brain.push({ id: Date.now(), title: t, content: c });
                    this.saveStores();
                    this.render();
                }
            }
            delBrain(id) { this.state.brain = this.state.brain.filter(b=>b.id!==id); this.saveStores(); this.render(); }

            createProj() {
                const n = document.getElementById('np-name').value;
                if(n && this.state.selBrId) {
                    this.state.projects.unshift({
                        id: Date.now().toString(),
                        name: n,
                        briefId: this.state.selBrId,
                        date: new Date().toLocaleDateString('fa-IR'),
                        data: {}
                    });
                    this.saveStores();
                    this.nav('wizard', this.state.projects[0].id);
                } else { alert('لطفا بریف و نام پروژه را مشخص کنید'); }
            }
            delProj(id) { this.state.projects = this.state.projects.filter(p=>p.id!==id); this.saveStores(); this.render(); }
            
            saveStores() {
                localStorage.setItem('avp_projects', JSON.stringify(this.state.projects));
                localStorage.setItem('avp_briefs', JSON.stringify(this.state.briefs));
                localStorage.setItem('avp_brain', JSON.stringify(this.state.brain));
            }

            setD(k, v) { this.state.temp[k] = v; }
            setCF(k, v) {
                if(!this.state.temp.cf) this.state.temp.cf = {};
                this.state.temp.cf[k] = v;
            }
            
            step(d) {
                const ns = this.state.step + d;
                if(ns > 5) {
                    // ذخیره نهایی
                    const i = this.state.projects.findIndex(p => p.id == this.state.activeProj.id);
                    this.state.projects[i].data = { ...this.state.temp };
                    this.saveStores();
                    this.nav('home');
                } else if(ns >= 1) {
                    this.state.step = ns;
                    this.render();
                }
            }

            // --- تابع اتصال به هوش مصنوعی (Universal) ---
            async callAI(prompt, jsonMode = false) {
                const prov = this.state.provider;
                
                // ساخت کانتکست
                let sys = `ROLE: Professional Marketer & Copywriter. Language: Persian.\n`;
                
                // افزودن اطلاعات بریف
                if(this.state.activeBrief) {
                    const b = this.state.activeBrief;
                    sys += `BRAND PROFILE:\nName: ${b.name}\nTone: ${b.tone}\nAudience: ${b.aud}\nDescription: ${b.desc}\n\n`;
                }
                
                // افزودن مغز متفکر
                if(this.state.brain.length > 0) {
                    sys += `KNOWLEDGE BASE (Facts):\n`;
                    this.state.brain.forEach(d => sys += `Source [${d.title}]: ${d.content.substring(0, 600)}...\n`);
                }
                
                if(jsonMode) sys += "\nIMPORTANT: RETURN ONLY VALID JSON. NO MARKDOWN.";

                const fullPrompt = sys + "\nTASK: " + prompt;

                try {
                    if(prov === 'gemini') {
                        // اتصال جمنای
                        const url = `https://generativelanguage.googleapis.com/v1beta/models/${this.state.geminiModel}:generateContent?key=${this.state.geminiKey}`;
                        const r = await fetch(url, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ contents: [{ parts: [{ text: fullPrompt }] }] })
                        });
                        const j = await r.json();
                        if(j.error) return "ERR: " + j.error.message;
                        return j.candidates[0].content.parts[0].text;
                    } else {
                        // اتصال متیس / اوپن‌ای‌آی
                        // حذف اسلش آخر URL اگر وجود داشت
                        const baseUrl = this.state.customUrl.replace(/\/$/, "");
                        const url = `${baseUrl}/chat/completions`;
                        
                        const r = await fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.state.customKey}`
                            },
                            body: JSON.stringify({
                                model: this.state.customModel,
                                messages: [
                                    { role: 'system', content: sys },
                                    { role: 'user', content: prompt }
                                ]
                            })
                        });
                        const j = await r.json();
                        if(j.error) return "ERR: " + (j.error.message || JSON.stringify(j));
                        return j.choices[0].message.content;
                    }
                } catch(e) {
                    return "ERR: Network Error - " + e.message;
                }
            }

            // تمیزکننده JSON برای وقتی که هوش مصنوعی متن اضافه می‌فرستد
            cleanJSON(t) {
                return t.replace(/```json/g, '').replace(/```/g, '').trim().match(/\{[\s\S]*\}/)?.[0] || t;
            }

            // تولید خودکار محتوا
            async autoFill() {
                const d = this.state.temp;
                const tmpl = FRAMEWORKS[d.tmpl];
                
                document.getElementById('f-cont').innerHTML = '<div class="flicker text-accent">درحال تفکر و نوشتن...</div>';
                
                const p = `Write creative ad copy for framework "${d.tmpl}".
                Objective: ${d.obj}
                Topic: ${d.topic}
                Message: ${d.msg}
                Return JSON with keys: ${tmpl.fields.map(x => x.id).join(', ')}`;
                
                const r = await this.callAI(p, true);
                
                if(r.startsWith("ERR")) { alert(r); this.render(); return; }
                
                try {
                    const j = JSON.parse(this.cleanJSON(r));
                    if(!d.cf) d.cf = {};
                    tmpl.fields.forEach(f => {
                        if(j[f.id]) d.cf[f.id] = j[f.id];
                    });
                } catch(e) {
                    console.log(r);
                    alert("خطا در پردازش پاسخ هوش مصنوعی");
                }
                this.render();
            }

            // تحلیل محتوا
            async analyze() {
                const b = document.getElementById('b-anlz');
                b.innerText = 'درحال تحلیل...'; b.disabled = true;
                
                let t = "";
                if(this.state.temp.cf) Object.values(this.state.temp.cf).forEach(v => t += v + "\n");
                
                const res = await this.callAI(`Analyze this ad copy: ${t}. Provide bullet points: Strengths, Weaknesses, and Improvements.`);
                
                document.getElementById('r-anlz').innerText = res;
                document.getElementById('r-anlz').classList.remove('hidden');
                b.innerText = 'شروع تحلیل'; b.disabled = false;
            }

            // کپشن نویسی
            async caption() {
                const b = document.getElementById('b-cap');
                b.innerText = '...'; b.disabled = true;
                
                let t = "";
                if(this.state.temp.cf) Object.values(this.state.temp.cf).forEach(v => t += v + "\n");
                
                const res = await this.callAI(`Write an engaging social media caption for this text: ${t}. Include relevant emojis and hashtags.`);
                
                this.state.temp.cap = res;
                document.getElementById('fcap').value = res;
                b.innerText = 'تولید کپشن'; b.disabled = false;
            }
        }

        // اجرای برنامه
        const app = new App();
    </script>
</body>
</html>