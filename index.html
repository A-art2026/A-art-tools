<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A_art Planner | Ù†Ø³Ø®Ù‡ Û¶.Û° (ÙÛŒÚ©Ø³ Ú©Ø§Ù…Ù„)</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;700&family=Vazirmatn:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <!-- PDF Lib -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>

    <style>
        /* --- DESIGN SYSTEM --- */
        :root {
            --bg-body: #050505; --bg-card: #141414; --bg-modal: #1a1a1a; --bg-input: #0a0a0a;
            --accent: #ccff00; --accent-dim: rgba(204, 255, 0, 0.15);
            --text-main: #f0f0f0; --text-muted: #888888; --border: #333333; --radius: 12px;
            --light-green: #00ff66; --light-yellow: #ffcc00; --light-red: #ff3333; --light-off: #333;
            --font-fa: 'Vazirmatn', sans-serif; --font-en: 'Lexend', sans-serif;
        }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-body); color: var(--text-main); font-family: var(--font-fa); margin: 0; padding: 0; min-height: 100vh; padding-bottom: 100px; overflow-x: hidden; }
        
        #aura { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; background: radial-gradient(circle at 50% 30%, rgba(204,255,0,0.04), transparent 70%); animation: pulse 8s infinite alternate; }
        @keyframes pulse { 0% { opacity: 0.5; transform: scale(1); } 100% { opacity: 0.8; transform: scale(1.1); } }

        .container { max-width: 950px; margin: 0 auto; padding: 20px; }
        h1, h2, h3, h4 { color: #fff; font-weight: 700; margin: 0 0 15px 0; }
        .font-en { font-family: var(--font-en); direction: ltr; text-align: left; }
        .text-accent { color: var(--accent); } .text-muted { color: var(--text-muted); font-size: 0.85rem; }
        
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 24px; margin-bottom: 20px; transition: 0.2s; position: relative; }
        .card:hover { border-color: #444; }
        
        input, select, textarea { width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: #fff; padding: 12px 16px; border-radius: 8px; font-family: var(--font-fa); font-size: 0.95rem; margin-bottom: 15px; transition: 0.3s; }
        input:focus, select:focus, textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-dim); }
        
        .btn { background: transparent; border: 1px solid var(--border); color: var(--text-main); padding: 10px 20px; border-radius: 8px; cursor: pointer; font-family: var(--font-fa); font-size: 0.9rem; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:hover { border-color: var(--accent); color: var(--accent); }
        .btn-primary { background: var(--accent); color: #000; border: none; font-weight: 700; }
        .btn-primary:hover { background: #b3e600; transform: translateY(-1px); box-shadow: 0 4px 15px var(--accent-dim); }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
        .btn-close-icon { background: rgba(255,255,255,0.1); border: none; color: #fff; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-close-icon:hover { background: #ff3333; }

        header { background: rgba(5,5,5,0.9); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border); padding: 15px 0; position: sticky; top: 0; z-index: 100; margin-bottom: 30px; }
        .logo-img { height: 40px; display: block; object-fit: contain; }
        
        .nav-link { background: none; border: none; color: var(--text-muted); cursor: pointer; margin-left: 15px; font-size: 0.9rem; font-family: var(--font-fa); padding: 5px 10px; border-radius: 6px; transition: 0.3s; }
        .nav-link.active { background: rgba(255,255,255,0.05); color: var(--accent); }

        dialog { background: var(--bg-modal); color: var(--text-main); border: 1px solid var(--border); border-radius: 16px; width: 90%; max-width: 600px; padding: 0; box-shadow: 0 20px 60px rgba(0,0,0,0.9); position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; }
        dialog::backdrop { background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.03); }
        .modal-body { padding: 20px; max-height: 70vh; overflow-y: auto; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; background: rgba(0,0,0,0.2); }

        .tabs { display: flex; gap: 5px; margin-bottom: 15px; background: #222; padding: 4px; border-radius: 8px; }
        .tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; border-radius: 6px; font-size: 0.9rem; color: #888; }
        .tab.active { background: var(--accent); color: #000; font-weight: bold; }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .flex { display: flex; } .justify-between { justify-content: space-between; } .items-center { align-items: center; }
        .hidden { display: none !important; } .mt-4 { margin-top: 16px; }

        .step-indicator { display: flex; gap: 5px; margin-bottom: 20px; }
        .step-dot { flex: 1; height: 4px; background: #333; border-radius: 2px; transition: 0.3s; }
        .step-dot.active { background: var(--accent); box-shadow: 0 0 5px var(--accent); }
        
        .flicker { animation: blink 1s infinite alternate; color: var(--accent); }
        @keyframes blink { 0% { opacity: 1; } 100% { opacity: 0.5; } }

        /* Checklist & Analysis */
        .checklist-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #222; border-radius: 8px; margin-bottom: 8px; border: 1px solid #333; }
        .light { width: 14px; height: 14px; border-radius: 50%; background: var(--light-off); box-shadow: inset 0 0 2px rgba(0,0,0,0.5); }
        .light.green { background: var(--light-green); box-shadow: 0 0 8px var(--light-green); }
        .light.yellow { background: var(--light-yellow); box-shadow: 0 0 8px var(--light-yellow); }
        .light.red { background: var(--light-red); box-shadow: 0 0 8px var(--light-red); }

        .analysis-box { background: #222; padding: 15px; border-radius: 8px; margin-top: 10px; border-right: 3px solid #333; }
        .analysis-box h4 { margin: 0 0 10px 0; font-size: 0.95rem; }
        .analysis-box ul { margin: 0; padding-right: 20px; font-size: 0.85rem; color: #ccc; }

        /* Copy Button */
        .copy-btn { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6); color: #fff; border: 1px solid #444; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 0.75rem; }
        .copy-btn:hover { border-color: var(--accent); color: var(--accent); }

        @media (max-width: 768px) { .grid-2, .grid-3 { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div id="aura"></div>

    <!-- SETTINGS MODAL -->
    <dialog id="settings-modal">
        <div class="modal-header">
            <h3>ØªÙ†Ø¸ÛŒÙ…Ø§Øª API</h3>
            <button class="btn-close-icon" onclick="document.getElementById('settings-modal').close()">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="tabs">
                <div class="tab active" id="t-gemini" onclick="app.setTab('gemini')">Google Gemini</div>
                <div class="tab" id="t-openai" onclick="app.setTab('openai')">Metis / OpenAI</div>
            </div>
            <div id="conf-gemini">
                <p class="text-muted">Ù†ÛŒØ§Ø² Ø¨Ù‡ ÙÛŒÙ„ØªØ±Ø´Ú©Ù†.</p>
                <label>API Key</label><input type="password" id="gemini-key" class="font-en" placeholder="AIzaSy...">
                <label>Model</label><input list="gemini-list" id="gemini-model" class="font-en" placeholder="gemini-2.0-flash-exp"><datalist id="gemini-list"><option value="gemini-2.0-flash-exp"/><option value="gemini-1.5-flash"/></datalist>
            </div>
            <div id="conf-openai" class="hidden">
                <p class="text-muted">Ø§ØªØµØ§Ù„ Ø¨Ø¯ÙˆÙ† ØªØ­Ø±ÛŒÙ… (Metis/Proxy).</p>
                <label>Base URL</label><input type="text" id="custom-url" class="font-en" placeholder="https://api.metisai.ir/openai/v1">
                <label>API Key</label><input type="password" id="custom-key" class="font-en" placeholder="sk-...">
                <label>Model Name</label><input type="text" id="custom-model" class="font-en" placeholder="gpt-4o-mini">
            </div>
            <div style="margin-top:15px; padding:10px; background:rgba(255,255,255,0.05); border-radius:8px;">
                <span id="conn-status" class="font-en" style="font-size:0.8rem; color:#aaa"></span>
                <button class="btn btn-sm mt-2 w-full" onclick="app.testConn()">ØªØ³Øª Ø§ØªØµØ§Ù„</button>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="document.getElementById('settings-modal').close()">Ø§Ù†ØµØ±Ø§Ù</button>
            <button class="btn btn-primary" onclick="app.saveSettings()">Ø°Ø®ÛŒØ±Ù‡</button>
        </div>
    </dialog>

    <header>
        <div class="container flex justify-between items-center">
            <!-- LOGO: IMAGE PLACEHOLDER -->
            <img src="https://placehold.co/160x40/000000/CCFF00?text=A_art+Tools&font=playfair-display" alt="A_art Tools" class="logo-img" id="main-logo">
            
            <nav>
                <button class="nav-link active" onclick="app.nav('home')">Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§</button>
                <button class="nav-link" onclick="app.nav('briefs')">Ø¨Ø±ÛŒÙâ€ŒÙ‡Ø§</button>
                <button class="nav-link" onclick="app.nav('templates')">ØªÙ…Ù¾Ù„ÛŒØªâ€ŒÙ‡Ø§</button>
                <button class="nav-link" onclick="app.nav('brain')">Ù…ØºØ² Ù…ØªÙÚ©Ø±</button>
                <button class="nav-link" onclick="document.getElementById('settings-modal').showModal()">âš™ï¸ API</button>
            </nav>
        </div>
    </header>

    <main id="root" class="container"></main>

    <script>
        const FRAMEWORKS = {
            'AIDA': {
                name: 'AIDA', desc: 'Ù…Ø¯Ù„ Ú©Ù„Ø§Ø³ÛŒÚ© ÙØ±ÙˆØ´',
                fields: [ {id:'att',label:'Attention',hint:'ØªÛŒØªØ± Û³ Ø«Ø§Ù†ÛŒÙ‡â€ŒØ§ÛŒ'}, {id:'int',label:'Interest',hint:'Ø¬Ø°Ø§Ø¨ÛŒØª Ùˆ Ø±Ø¨Ø·'}, {id:'des',label:'Desire',hint:'Ø§Ø´ØªÛŒØ§Ù‚ Ùˆ Ù…Ø²Ø§ÛŒØ§'}, {id:'act',label:'Action',hint:'Ø¯Ø¹ÙˆØª Ø¨Ù‡ Ø§Ù‚Ø¯Ø§Ù…'} ]
            },
            'PAS': {
                name: 'PAS', desc: 'Ø­Ù„ Ø¯Ø±Ø¯ Ù…Ø´ØªØ±ÛŒ',
                fields: [ {id:'prob',label:'Problem',hint:'Ø¯Ø±Ø¯ Ù…Ø´ØªØ±ÛŒ'}, {id:'agi',label:'Agitate',hint:'ØªØ´Ø¯ÛŒØ¯ Ù…Ø´Ú©Ù„'}, {id:'sol',label:'Solution',hint:'Ø±Ø§Ù‡ Ø­Ù„ Ø´Ù…Ø§'} ]
            },
            'StoryBrand': {
                name: 'StoryBrand', desc: 'Ø³ÙØ± Ù‚Ù‡Ø±Ù…Ø§Ù†',
                fields: [ {id:'char',label:'Ø´Ø®ØµÛŒØª',hint:'Ù‚Ù‡Ø±Ù…Ø§Ù†'}, {id:'prob',label:'Ù…Ø´Ú©Ù„',hint:'Ù…Ø§Ù†Ø¹'}, {id:'guide',label:'Ø±Ø§Ù‡Ù†Ù…Ø§',hint:'Ø¨Ø±Ù†Ø¯ Ø´Ù…Ø§'}, {id:'plan',label:'Ù†Ù‚Ø´Ù‡',hint:'Ù…Ø³ÛŒØ±'}, {id:'cta',label:'CTA',hint:'Ø¯Ø¹ÙˆØª'}, {id:'res',label:'Ù…ÙˆÙÙ‚ÛŒØª',hint:'Ù¾ÛŒØ±ÙˆØ²ÛŒ'} ]
            },
            '4Ps': {
                name: '4Ps', desc: 'ØªØµÙˆÛŒØ±Ø³Ø§Ø²ÛŒ Ø¢ÛŒÙ†Ø¯Ù‡',
                fields: [ {id:'pic',label:'Picture',hint:'ØªØµÙˆÛŒØ± Ø¢ÛŒÙ†Ø¯Ù‡'}, {id:'prom',label:'Promise',hint:'Ù‚ÙˆÙ„ Ø¨Ø±Ù†Ø¯'}, {id:'proof',label:'Proof',hint:'Ø§Ø«Ø¨Ø§Øª'}, {id:'push',label:'Push',hint:'Ù‡Ù„ Ø¯Ø§Ø¯Ù†'} ]
            },
            'APP': {
                name: 'APP', desc: 'Ù…Ø­ØªÙˆØ§ÛŒ Ø¢Ù…ÙˆØ²Ø´ÛŒ',
                fields: [ {id:'awa',label:'Awareness',hint:'Ø¢Ú¯Ø§Ù‡ÛŒ'}, {id:'prob',label:'Problem',hint:'Ù…Ø´Ú©Ù„'}, {id:'pos',label:'Positioning',hint:'Ø¬Ø§ÛŒÚ¯Ø§Ù‡ Ù…Ø§'} ]
            }
        };

        class App {
            constructor() {
                this.state = {
                    view: 'home',
                    projects: JSON.parse(localStorage.getItem('avp_projects') || '[]'),
                    briefs: JSON.parse(localStorage.getItem('avp_briefs') || '[]'),
                    brain: JSON.parse(localStorage.getItem('avp_brain') || '[]'),
                    provider: localStorage.getItem('avp_provider') || 'gemini',
                    geminiKey: localStorage.getItem('avp_gemini_key') || '',
                    geminiModel: localStorage.getItem('avp_gemini_model') || 'gemini-1.5-flash',
                    customUrl: localStorage.getItem('avp_custom_url') || 'https://api.metisai.ir/openai/v1',
                    customKey: localStorage.getItem('avp_custom_key') || '',
                    customModel: localStorage.getItem('avp_custom_model') || 'gpt-4o-mini',
                    activeProj: null, activeBrief: null, step: 1, temp: {}, loading: false
                };
                
                setTimeout(() => {
                    document.getElementById('gemini-key').value = this.state.geminiKey;
                    document.getElementById('gemini-model').value = this.state.geminiModel;
                    document.getElementById('custom-url').value = this.state.customUrl;
                    document.getElementById('custom-key').value = this.state.customKey;
                    document.getElementById('custom-model').value = this.state.customModel;
                    this.setTab(this.state.provider);
                }, 100);

                if(!this.state.geminiKey && !this.state.customKey) setTimeout(() => document.getElementById('settings-modal').showModal(), 1000);
                this.render();
            }

            setTab(p) { this.state.provider = p; document.querySelectorAll('.tab').forEach(e => e.classList.remove('active')); document.getElementById('t-'+p).classList.add('active'); document.getElementById('conf-gemini').classList.add('hidden'); document.getElementById('conf-openai').classList.add('hidden'); document.getElementById('conf-'+p).classList.remove('hidden'); }
            saveSettings() { this.state.geminiKey=document.getElementById('gemini-key').value.trim(); this.state.geminiModel=document.getElementById('gemini-model').value.trim(); this.state.customUrl=document.getElementById('custom-url').value.trim(); this.state.customKey=document.getElementById('custom-key').value.trim(); this.state.customModel=document.getElementById('custom-model').value.trim(); localStorage.setItem('avp_provider',this.state.provider); localStorage.setItem('avp_gemini_key',this.state.geminiKey); localStorage.setItem('avp_gemini_model',this.state.geminiModel); localStorage.setItem('avp_custom_url',this.state.customUrl); localStorage.setItem('avp_custom_key',this.state.customKey); localStorage.setItem('avp_custom_model',this.state.customModel); document.getElementById('settings-modal').close(); alert('ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯'); }
            
            async testConn() {
                const s = document.getElementById('conn-status'); s.innerText = 'Ø¯Ø±Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...'; s.style.color = '#ffcc00';
                try {
                    const res = await this.callAI("Say OK", false);
                    if(res.startsWith("ERR")) throw new Error(res);
                    s.innerText = 'Ù…ØªØµÙ„ Ø´Ø¯ âœ…'; s.style.color = '#00ff66';
                } catch(e) { s.innerText = 'Ø®Ø·Ø§: ' + e.message; s.style.color = '#ff3333'; }
            }

            nav(view, id = null) {
                this.state.view = view; document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                const map = {'home':0, 'briefs':1, 'templates':2, 'brain':3};
                if(map[view]!==undefined) document.querySelectorAll('.nav-link')[map[view]].classList.add('active');
                if (view === 'wizard') {
                    const p = this.state.projects.find(x => x.id === id);
                    this.state.activeProj = p;
                    this.state.activeBrief = this.state.briefs.find(b => b.id === p.briefId) || this.state.briefs[0];
                    this.state.temp = { ...p.data };
                    this.state.step = 1;
                }
                this.render();
            }

            render() { const root = document.getElementById('root'); root.innerHTML = ''; switch(this.state.view) { case 'home': root.innerHTML = this.viewHome(); break; case 'briefs': root.innerHTML = this.viewBriefs(); break; case 'templates': root.innerHTML = this.viewTemplates(); break; case 'brain': root.innerHTML = this.viewBrain(); break; case 'setup': root.innerHTML = this.viewSetup(); break; case 'wizard': this.renderWizard(root); break; } }

            viewHome() {
                return `<div class="flex justify-between items-center mb-4"><h2>Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§</h2><button class="btn btn-primary" onclick="app.nav('setup')">+ Ù¾Ø±ÙˆÚ˜Ù‡ Ø¬Ø¯ÛŒØ¯</button></div><div class="grid-3">${this.state.projects.map(p => { const b = this.state.briefs.find(x=>x.id===p.briefId); return `<div class="card" onclick="app.nav('wizard','${p.id}')" style="cursor:pointer"><h3>${p.name}</h3><div style="font-size:0.8rem;color:#888;margin:10px 0">${p.plat} | ${b?b.name:'-'}</div><button class="btn btn-sm" onclick="event.stopPropagation();app.delProj('${p.id}')">Ø­Ø°Ù</button></div>` }).join('')}</div>${this.state.projects.length===0?'<div class="text-center text-muted">Ø®Ø§Ù„ÛŒ</div>':''}`;
            }
            viewTemplates() {
                return `<h2>ØªÙ…Ù¾Ù„ÛŒØªâ€ŒÙ‡Ø§</h2><div class="grid-2">${Object.keys(FRAMEWORKS).map(k=>{const f=FRAMEWORKS[k]; return `<div class="card"><h3 class="text-accent">${f.name}</h3><p style="font-size:0.9rem">${f.desc}</p></div>`}).join('')}</div>`;
            }
            viewBriefs() {
                return `
                    <div class="card" style="border-top:4px solid var(--accent)">
                        <h2>Ø³Ø§Ø®Øª Ø¨Ø±ÛŒÙ Ø¬Ø¯ÛŒØ¯</h2>
                        <div class="grid-2">
                            <div><label>Ù†Ø§Ù… Ø¨Ø±Ù†Ø¯</label><input id="bf-name"></div>
                            <div>
                                <label>ØªÚ©Ù…ÛŒÙ„ Ø¨Ø§ ÙØ§ÛŒÙ„ (PDF/TXT)</label>
                                <div class="flex" style="gap:5px">
                                    <input type="file" id="bf-file" accept=".pdf,.txt" style="font-size:0.8rem">
                                    <button class="btn btn-sm" onclick="app.autoFillBrief()">âœ¨ AI</button>
                                </div>
                            </div>
                        </div>
                        <label>Ù„Ø­Ù† Ø¨Ø±Ù†Ø¯</label><input id="bf-tone">
                        <label>ØªÙˆØ¶ÛŒØ­Ø§Øª</label><textarea id="bf-desc" rows="2"></textarea>
                        <label>Ù…Ø®Ø§Ø·Ø¨</label><textarea id="bf-aud" rows="2"></textarea>
                        <button class="btn btn-primary w-full" onclick="app.addBrief()">Ø°Ø®ÛŒØ±Ù‡</button>
                    </div>
                    <div class="grid-3 mt-4">${this.state.briefs.map(b => `<div class="card"><h3 class="text-accent">${b.name}</h3><button class="btn btn-sm mt-2" onclick="app.delBrief('${b.id}')">Ø­Ø°Ù</button></div>`).join('')}</div>
                `;
            }
            viewBrain() {
                return `<div class="card"><h2>Ù…ØºØ² Ù…ØªÙÚ©Ø± (Ù…Ù†Ø§Ø¨Ø¹ Ø¯Ø§Ù†Ø´)</h2><div class="grid-2"><div><label>Ø¹Ù†ÙˆØ§Ù†</label><input id="br-title"><input type="file" onchange="app.handleFile(event)" accept=".pdf,.txt">${this.state.loading?'<span class="flicker">...</span>':''}</div><div><label>Ù…ØªÙ†</label><textarea id="br-text" rows="5"></textarea><button class="btn btn-primary w-full" onclick="app.addBrain()">Ø§ÙØ²ÙˆØ¯Ù†</button></div></div></div><div class="grid-3 mt-4">${this.state.brain.map(b => `<div class="card"><strong>${b.title}</strong><button class="btn btn-sm w-full mt-2" onclick="app.delBrain('${b.id}')">Ø­Ø°Ù</button></div>`).join('')}</div>`;
            }
            viewSetup() {
                if(this.state.briefs.length===0) return '<div class="text-center pt-5"><h2>Ø§ÙˆÙ„ Ø¨Ø±ÛŒÙ Ø¨Ø³Ø§Ø²ÛŒØ¯</h2><button class="btn btn-primary mt-4" onclick="app.nav(\'briefs\')">Ø³Ø§Ø®Øª Ø¨Ø±ÛŒÙ</button></div>';
                return `<h2>Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ø±ÛŒÙ</h2><div class="grid-3 mb-4">${this.state.briefs.map(b=>`<div class="card" id="br-${b.id}" onclick="app.selBr('${b.id}')" style="cursor:pointer;border:2px solid transparent;background:#1a1a1a"><strong>${b.name}</strong></div>`).join('')}</div><div class="card"><label>Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡</label><input id="np-name"><label>Ù¾Ù„ØªÙØ±Ù…</label><select id="np-plat"><option>Instagram Reel</option><option>Instagram Post</option><option>LinkedIn</option><option>Telegram</option></select><button class="btn btn-primary w-full mt-4" onclick="app.createProj()">Ø§ÛŒØ¬Ø§Ø¯</button></div>`;
            }
            selBr(id) { document.querySelectorAll('[id^="br-"]').forEach(e=>{e.style.borderColor='transparent';e.style.backgroundColor='#1a1a1a'}); document.getElementById('br-'+id).style.borderColor='var(--accent)'; document.getElementById('br-'+id).style.backgroundColor='var(--bg-card)'; this.state.selBrId=id; }

            renderWizard(root) {
                const s = this.state.step; const d = this.state.temp;
                let c = '';
                if(s===1) c = `<h3>Û±. Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ</h3><div class="grid-2"><div><label>Ù‡Ø¯Ù</label><select id="i-obj" onchange="app.setD('obj',this.value)"><option>Awareness</option><option>Sales</option><option>Engagement</option></select></div><div><label>Ù…ÙˆØ¶ÙˆØ¹</label><input value="${d.topic||''}" onchange="app.setD('topic',this.value)"></div></div><label>Ù¾ÛŒØ§Ù… Ø§ØµÙ„ÛŒ</label><textarea onchange="app.setD('msg',this.value)">${d.msg||''}</textarea>`;
                else if(s===2) { let rec='AIDA'; if(d.obj==='Sales')rec='PAS'; if(d.obj==='Engagement')rec='StoryBrand'; if(!d.tmpl)d.tmpl=rec; c = `<h3>Û². Ø§Ù†ØªØ®Ø§Ø¨ Ù‚Ø§Ù„Ø¨</h3><div class="card" style="border-color:var(--accent)"><strong class="text-accent">Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: ${rec}</strong></div><select id="i-tmpl" onchange="app.setD('tmpl',this.value);app.render()">${Object.keys(FRAMEWORKS).map(k=>`<option value="${k}" ${d.tmpl==k?'selected':''}>${FRAMEWORKS[k].name}</option>`).join('')}</select>`; }
                else if(s===3) { 
                    const f=FRAMEWORKS[d.tmpl].fields; 
                    c = `<h3>Û³. ØªÙˆÙ„ÛŒØ¯ Ù…Ø­ØªÙˆØ§ (${d.tmpl})</h3>
                    <div style="display:flex;gap:10px;margin-bottom:20px">
                        <button class="btn btn-sm" onclick="app.autoFill()" style="border:1px solid var(--accent);color:var(--accent)">âœ¨ Ù†ÙˆØ´ØªÙ† Ø®ÙˆØ¯Ú©Ø§Ø±</button>
                        <button class="btn btn-sm" onclick="app.refineContent()">ğŸ”§ Ø¨Ù‡Ø¨ÙˆØ¯ Ù…ØªÙ† Ø¨Ø§ AI</button>
                    </div>
                    <div id="f-cont">${f.map(x=>`<div class="mb-4"><label class="text-accent">${x.label}</label><p class="text-muted" style="font-size:0.8rem">${x.hint}</p><textarea rows="3" id="in-${x.id}" onchange="app.setCF('${x.id}',this.value)">${(d.cf&&d.cf[x.id])||''}</textarea></div>`).join('')}</div>`; 
                }
                else if(s===4) { 
                    c = `<h3>Û´. Ø¨Ø±Ø±Ø³ÛŒ Ú©ÛŒÙÛŒ (Ø¢Ù†Ø§Ù„ÛŒØ²)</h3>
                    <button class="btn btn-primary w-full" id="b-anlz" onclick="app.analyze()">Ø´Ø±ÙˆØ¹ ØªØ­Ù„ÛŒÙ„</button>
                    <div id="check-res" class="mt-4 hidden"></div>`; 
                }
                else if(s===5) { 
                    let t=`Ù¾Ù„ØªÙØ±Ù…: ${this.state.activeProj.plat}\nÙ‚Ø§Ù„Ø¨: ${d.tmpl}\n\n`; if(d.cf) Object.values(d.cf).forEach(v=>t+=v+"\n\n"); 
                    c = `<h3>Ûµ. Ø®Ø±ÙˆØ¬ÛŒ Ù†Ù‡Ø§ÛŒÛŒ</h3>
                    <div class="grid-2">
                        <div style="position:relative">
                            <label>Ø³Ù†Ø§Ø±ÛŒÙˆ Ú©Ø§Ù…Ù„</label><textarea rows="12" id="ftxt">${t}</textarea>
                            <button class="copy-btn" onclick="app.copyTo('ftxt')">Ú©Ù¾ÛŒ</button>
                        </div>
                        <div style="position:relative">
                            <label>Ú©Ù¾Ø´Ù†</label><button class="btn btn-primary w-full mb-2" id="b-cap" onclick="app.caption()">ØªÙˆÙ„ÛŒØ¯ Ú©Ù¾Ø´Ù†</button><textarea rows="9" id="fcap">${d.cap||''}</textarea>
                            <button class="copy-btn" style="top:55px" onclick="app.copyTo('fcap')">Ú©Ù¾ÛŒ</button>
                        </div>
                    </div>`; 
                }

                root.innerHTML = `<div class="flex justify-between items-center mb-4"><button class="btn" onclick="app.nav('home')">Ø®Ø±ÙˆØ¬</button><span>${this.state.activeProj.name}</span></div><div class="step-indicator">${[1,2,3,4,5].map(i=>`<div class="step-dot ${i<=s?'active':''}"></div>`).join('')}</div><div class="card" style="min-height:400px">${c}</div><div class="flex justify-between"><button class="btn" onclick="app.step(-1)" ${s==1?'disabled':''}>Ù‚Ø¨Ù„ÛŒ</button><button class="btn btn-primary" onclick="app.step(1)">${s==5?'Ù¾Ø§ÛŒØ§Ù†':'Ø¨Ø¹Ø¯ÛŒ'}</button></div>`;
            }

            // --- AI ACTIONS (Fixed) ---
            async autoFillBrief() {
                const f = document.getElementById('bf-file').files[0];
                if(!f) return alert('ÙØ§ÛŒÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡');
                let txt = "";
                try {
                    if(f.type === 'application/pdf') {
                        const ab = await f.arrayBuffer(); const pdf = await pdfjsLib.getDocument(ab).promise;
                        for(let i=1; i<=pdf.numPages; i++){ const p=await pdf.getPage(i); const c=await p.getTextContent(); txt+=c.items.map(s=>s.str).join(' ')+'\n'; }
                    } else txt = await f.text();
                } catch(e) { return alert('Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„'); }

                const prompt = `Extract brand info from text. JSON: {"name":"", "tone":"", "aud":"", "desc":""}. Text: ${txt.substring(0,3000)}`;
                const res = await this.callAI(prompt, true);
                try {
                    const j = JSON.parse(this.cleanJSON(res));
                    document.getElementById('bf-name').value = j.name||''; document.getElementById('bf-tone').value = j.tone||'';
                    document.getElementById('bf-aud').value = j.aud||''; document.getElementById('bf-desc').value = j.desc||'';
                } catch(e) { alert('ÙØ±Ù…Øª Ù¾Ø§Ø³Ø® Ù†Ø§Ù…Ø¹ØªØ¨Ø±'); }
            }

            async refineContent() {
                const d=this.state.temp;
                if(!d.cf) return alert('Ø§Ø¨ØªØ¯Ø§ Ù…ØªÙ† Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯');
                const cont = document.getElementById('f-cont');
                const oldHTML = cont.innerHTML;
                cont.innerHTML = '<div class="flicker text-accent">Ø¯Ø±Ø­Ø§Ù„ Ø¨Ù‡Ø¨ÙˆØ¯ Ù…ØªÙ†...</div>';
                
                let inputs = ""; Object.entries(d.cf).forEach(([k,v]) => inputs += `${k}: ${v}\n`);
                const p = `Refine this content to be more engaging. Framework: ${d.tmpl}. Inputs:\n${inputs}\nReturn JSON with keys matching input keys.`;
                const r = await this.callAI(p, true);
                
                try {
                    const j = JSON.parse(this.cleanJSON(r));
                    Object.keys(j).forEach(k => { if(d.cf[k]) d.cf[k] = j[k]; });
                    this.render(); // Re-render to show updated text
                } catch(e) { 
                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡Ø¨ÙˆØ¯'); 
                    cont.innerHTML = oldHTML;
                }
            }

            async analyze() {
                const b = document.getElementById('b-anlz'); b.innerText = 'Ø¯Ø±Ø­Ø§Ù„ ØªØ­Ù„ÛŒÙ„...'; b.disabled = true;
                let t = ""; if(this.state.temp.cf) Object.values(this.state.temp.cf).forEach(v => t += v + "\n");
                
                const p = `Audit ad copy: "${t}".
                Evaluate: Hook, Value, CTA, Tone.
                Return JSON: {"hook":"green/yellow/red", "value":"green/yellow/red", "cta":"green/yellow/red", "tone":"green/yellow/red", 
                "strengths":["..."], "weaknesses":["..."], "suggestions":["..."]}`;
                
                const res = await this.callAI(p, true);
                let html = "";
                
                try {
                    const j = JSON.parse(this.cleanJSON(res));
                    // Traffic Lights
                    const labels = {hook:'Ù‚Ø¯Ø±Øª Ù‡ÙˆÚ©', value:'Ø§Ø±Ø²Ø´', cta:'CTA', tone:'Ù„Ø­Ù†'};
                    ['hook','value','cta','tone'].forEach(k => html += `<div class="checklist-item"><span>${labels[k]}</span><div class="light ${j[k]||'red'}"></div></div>`);
                    
                    // Detailed Feedback
                    html += `<div style="background:#111; padding:15px; border-radius:8px; margin-top:15px">
                        <strong class="text-accent">Ù…ØªÙ† Ø´Ù…Ø§:</strong>
                        <p style="font-size:0.8rem; color:#aaa; margin-top:5px; white-space:pre-wrap; border-left:2px solid #444; padding-left:10px">${t}</p>
                    </div>`;
                    
                    if(j.strengths) html += `<div class="analysis-box" style="border-right-color:var(--light-green)"><h4 style="color:var(--light-green)">Ù†Ù‚Ø§Ø· Ù‚ÙˆØª</h4><ul>${j.strengths.map(s=>`<li>${s}</li>`).join('')}</ul></div>`;
                    if(j.weaknesses) html += `<div class="analysis-box" style="border-right-color:var(--light-red)"><h4 style="color:var(--light-red)">Ù†Ù‚Ø§Ø· Ø¶Ø¹Ù</h4><ul>${j.weaknesses.map(s=>`<li>${s}</li>`).join('')}</ul></div>`;
                    if(j.suggestions) html += `<div class="analysis-box" style="border-right-color:var(--light-yellow)"><h4 style="color:var(--light-yellow)">Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª</h4><ul>${j.suggestions.map(s=>`<li>${s}</li>`).join('')}</ul></div>`;

                } catch(e) { html = "Ø®Ø·Ø§ Ø¯Ø± ØªØ­Ù„ÛŒÙ„: " + res; }

                const div = document.getElementById('check-res');
                div.innerHTML = html; div.classList.remove('hidden');
                b.innerText = 'ØªØ­Ù„ÛŒÙ„ Ù…Ø¬Ø¯Ø¯'; b.disabled = false;
            }

            // --- STANDARD FUNCTIONS ---
            addBrief(){const n=document.getElementById('bf-name').value;if(n){this.state.briefs.push({id:Date.now().toString(),name:n,desc:document.getElementById('bf-desc').value,aud:document.getElementById('bf-aud').value,tone:document.getElementById('bf-tone').value});this.saveStores();this.render();}}
            delBrief(id){this.state.briefs=this.state.briefs.filter(b=>b.id!==id);this.saveStores();this.render();}
            async handleFile(e){const f=e.target.files[0]; if(!f)return; this.state.loading=true; this.render(); try{let t=""; if(f.type=='application/pdf'){const a=await f.arrayBuffer(),p=await pdfjsLib.getDocument(a).promise;for(let i=1;i<=p.numPages;i++){const g=await p.getPage(i),c=await g.getTextContent();t+=c.items.map(s=>s.str).join(' ')+'\n';}}else t=await f.text(); document.getElementById('br-text').value=t; if(!document.getElementById('br-title').value)document.getElementById('br-title').value=f.name;}catch(e){alert('Ø®Ø·Ø§')}this.state.loading=false;this.render();}
            addBrain(){const t=document.getElementById('br-title').value,c=document.getElementById('br-text').value;if(t&&c){this.state.brain.push({id:Date.now(),title:t,content:c});this.saveStores();this.render();}}
            delBrain(id){this.state.brain=this.state.brain.filter(b=>b.id!==id);this.saveStores();this.render();}
            createProj(){const n=document.getElementById('np-name').value,pl=document.getElementById('np-plat').value; if(n&&this.state.selBrId){this.state.projects.unshift({id:Date.now().toString(),name:n,briefId:this.state.selBrId,plat:pl,data:{}});this.saveStores();this.nav('wizard',this.state.projects[0].id);}}
            delProj(id){this.state.projects=this.state.projects.filter(p=>p.id!==id);this.saveStores();this.render();}
            saveStores(){localStorage.setItem('avp_projects',JSON.stringify(this.state.projects));localStorage.setItem('avp_briefs',JSON.stringify(this.state.briefs));localStorage.setItem('avp_brain',JSON.stringify(this.state.brain));}
            setD(k,v){this.state.temp[k]=v;}
            setCF(k,v){if(!this.state.temp.cf)this.state.temp.cf={};this.state.temp.cf[k]=v;}
            step(d){const ns=this.state.step+d; if(ns>5){const i=this.state.projects.findIndex(p=>p.id==this.state.activeProj.id);this.state.projects[i].data={...this.state.temp};this.saveStores();this.nav('home');}else if(ns>=1){this.state.step=ns;this.render();}}
            copyTo(id){const el=document.getElementById(id);el.select();document.execCommand('copy');alert('Ú©Ù¾ÛŒ Ø´Ø¯');}

            async callAI(prompt, jsonMode=false) {
                const prov = this.state.provider;
                let sys = `ROLE: Marketer. Platform:${this.state.activeProj?.plat||'General'}. Brand:${this.state.activeBrief?.name||''}. Tone:${this.state.activeBrief?.tone||''}.\nKnowledge:\n`;
                this.state.brain.forEach(d=>sys+=`${d.title}:${d.content.substring(0,600)}...\n`);
                if(jsonMode) sys+="RETURN ONLY VALID JSON.";
                try {
                    let u, h, b;
                    if(prov==='gemini') { u=`https://generativelanguage.googleapis.com/v1beta/models/${this.state.geminiModel}:generateContent?key=${this.state.geminiKey}`; h={'Content-Type':'application/json'}; b=JSON.stringify({contents:[{parts:[{text:sys+"\nTask: "+prompt}]}]}); }
                    else { u=`${this.state.customUrl.replace(/\/$/,'')}/chat/completions`; h={'Content-Type':'application/json','Authorization':`Bearer ${this.state.customKey}`}; b=JSON.stringify({model:this.state.customModel,messages:[{role:'system',content:sys},{role:'user',content:prompt}]}); }
                    const r=await fetch(u,{method:'POST',headers:h,body:b}); if(!r.ok) return "ERR: "+r.status; const j=await r.json(); if(j.error) return "ERR: "+j.error.message;
                    return prov==='gemini' ? j.candidates[0].content.parts[0].text : j.choices[0].message.content;
                } catch(e) { return "ERR: "+e.message; }
            }
            cleanJSON(t) { return t.replace(/```json/g,'').replace(/```/g,'').trim().match(/\{[\s\S]*\}/)?.[0] || t; }
            async autoFill() {
                const d=this.state.temp, tmpl=FRAMEWORKS[d.tmpl||'AIDA'];
                document.getElementById('f-cont').innerHTML='<div class="flicker text-accent">Ø¯Ø±Ø­Ø§Ù„ Ù†ÙˆØ´ØªÙ†...</div>';
                const r=await this.callAI(`Write ad copy (${d.tmpl}). Obj:${d.obj}, Topic:${d.topic}, Msg:${d.msg}. Return JSON keys: ${tmpl.fields.map(x=>x.id).join(',')}`, true);
                if(r.startsWith("ERR")){alert(r);this.render();return;}
                try{const j=JSON.parse(this.cleanJSON(r));if(!d.cf)d.cf={};tmpl.fields.forEach(f=>{if(j[f.id])d.cf[f.id]=j[f.id]});}catch(e){alert("JSON Fail")}
                this.render();
            }
            async caption() {
                const b=document.getElementById('b-cap'); b.innerText='...'; b.disabled=true;
                let t=""; if(this.state.temp.cf) Object.values(this.state.temp.cf).forEach(v=>t+=v+"\n");
                const res=await this.callAI(`Write caption for: ${t}. Add hashtags.`, false);
                this.state.temp.cap=res; document.getElementById('fcap').value=res; b.innerText='Ú©Ù¾Ø´Ù†'; b.disabled=false;
            }
        }
        const app = new App();
    </script>
</body>
</html>