<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A_art Planner | Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ø§ PDF</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;700&family=Vazirmatn:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- PDF.js Library (External Resource for PDF Parsing) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙˆØ±Ú©Ø± Ø¨Ø±Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ PDF
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <style>
        /* --- CORE DESIGN SYSTEM --- */
        :root {
            --bg-deep: #050505;
            --bg-card: #141414;
            --bg-input: #0a0a0a;
            --accent: #CCFF00;
            --accent-glow: rgba(204, 255, 0, 0.3);
            --text-main: #F2F2F2;
            --text-muted: #888;
            --border: #333;
            --radius: 12px;
            --font-fa: 'Vazirmatn', sans-serif;
            --font-en: 'Lexend', sans-serif;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: var(--font-fa);
            margin: 0; padding: 0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- AURA BACKGROUND --- */
        #aura-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; pointer-events: none; overflow: hidden;
        }
        #aura-blob {
            position: absolute; top: 50%; left: 50%;
            width: 60vw; height: 60vw;
            background: radial-gradient(circle, rgba(204,255,0,0.06) 0%, rgba(5,5,5,0) 70%);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.2s ease-out;
            animation: pulse 10s infinite alternate;
        }
        @keyframes pulse { 0% { opacity: 0.5; transform: translate(-50%, -50%) scale(0.9); } 100% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); } }
        .aura-active { opacity: 0.2 !important; transform: translate(-50%, -50%) scale(0.8) !important; }

        /* --- LAYOUT & UTILS --- */
        .container { position: relative; z-index: 2; max-width: 900px; margin: 0 auto; padding: 20px; }
        .flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .w-full { width: 100%; }
        .mt-4 { margin-top: 20px; }
        .hidden { display: none !important; }

        /* --- TYPOGRAPHY --- */
        h1, h2, h3 { margin: 0 0 15px 0; color: #fff; font-weight: 700; }
        p { color: var(--text-muted); line-height: 1.7; font-size: 0.9rem; margin-bottom: 15px; }
        .font-en { font-family: var(--font-en); }

        /* --- COMPONENTS --- */
        
        /* Neon Card */
        .neon-wrapper {
            position: relative; padding: 2px; border-radius: var(--radius);
            background: linear-gradient(45deg, transparent, var(--border), transparent);
            margin-bottom: 25px; overflow: hidden;
        }
        .neon-wrapper.active { background: linear-gradient(45deg, transparent, var(--accent), transparent); }
        .card {
            background: var(--bg-card); border-radius: 10px; padding: 25px;
            position: relative; z-index: 2; border: 1px solid var(--border);
        }
        
        /* Inputs */
        label { display: block; color: var(--text-muted); margin-bottom: 8px; font-size: 0.85rem; }
        input, select, textarea {
            width: 100%; background: var(--bg-input); border: 1px solid var(--border);
            color: #fff; padding: 12px; border-radius: 8px;
            font-family: var(--font-fa); font-size: 0.95rem; margin-bottom: 15px;
            transition: 0.3s;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--accent); box-shadow: 0 0 10px var(--accent-glow); }

        /* Buttons */
        .btn {
            background: transparent; border: 1px solid var(--border); color: #fff;
            padding: 10px 20px; border-radius: 8px; cursor: pointer;
            font-family: var(--font-fa); font-size: 0.9rem; transition: 0.2s;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:hover { border-color: var(--accent); color: var(--accent); }
        .btn-primary { background: var(--accent); color: #000; border-color: var(--accent); font-weight: 800; }
        .btn-primary:hover { background: #b3e600; box-shadow: 0 0 20px var(--accent-glow); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Header */
        header {
            position: sticky; top: 0; z-index: 50;
            background: rgba(5,5,5,0.9); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border); padding: 15px 0;
        }
        .nav-link { background:none; border:none; color:var(--text-muted); cursor:pointer; font-family:var(--font-fa); margin-left:15px; transition:0.3s; }
        .nav-link.active { color: var(--accent); text-shadow: 0 0 10px var(--accent-glow); }

        /* Wizard Steps */
        .steps-bar { display: flex; justify-content: space-between; margin-bottom: 25px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .step-dot { opacity: 0.3; transition: 0.3s; font-size: 0.85rem; }
        .step-dot.active { opacity: 1; color: var(--accent); font-weight: bold; }

        /* Traffic Lights */
        .check-row { display: flex; justify-content: space-between; padding: 10px; background: #000; border-radius: 6px; margin-bottom: 5px; border: 1px solid #222; }
        .light { width: 12px; height: 12px; border-radius: 50%; background: #333; transition: 0.5s; box-shadow: inset 0 0 2px #000; }
        .light.green { background: #00ff66; box-shadow: 0 0 8px #00ff66; }
        .light.yellow { background: #ffcc00; box-shadow: 0 0 8px #ffcc00; }
        .light.red { background: #ff3333; box-shadow: 0 0 8px #ff3333; }

        /* Loading Spinner for PDF */
        .spinner { border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid var(--accent); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; margin-left: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Mobile */
        @media (max-width: 768px) { .grid-2, .grid-3 { grid-template-columns: 1fr; } .steps-bar { overflow-x: auto; gap: 15px; } }

        /* Modal */
        dialog { background: var(--bg-card); color: #fff; border: 1px solid var(--accent); border-radius: 12px; max-width: 500px; width: 90%; padding: 25px; box-shadow: 0 0 50px #000; }
        dialog::backdrop { background: rgba(0,0,0,0.8); }
    </style>
</head>
<body>

    <div id="aura-bg"><div id="aura-blob"></div></div>

    <!-- SETTINGS MODAL -->
    <dialog id="settings-modal">
        <h2 style="color:var(--accent)">ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</h2>
        <p>Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù…ØºØ² Ù…ØªÙÚ©Ø± Ùˆ Ø¢Ù†Ø§Ù„ÛŒØ²ÙˆØ±ØŒ Ú©Ù„ÛŒØ¯ Gemini API Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª.</p>
        <label>Google Gemini API Key</label>
        <input type="password" id="api-key-input" class="font-en" placeholder="AIzaSy...">
        <div class="flex justify-between">
            <button class="btn" onclick="document.getElementById('settings-modal').close()">Ø¨Ø³ØªÙ†</button>
            <button class="btn btn-primary" onclick="app.saveSettings()">Ø°Ø®ÛŒØ±Ù‡ Ú©Ù„ÛŒØ¯</button>
        </div>
    </dialog>

    <header>
        <div class="container flex justify-between items-center">
            <div style="font-family:'Lexend'; font-weight:900; font-size:1.4rem; color:#fff">
                <span style="color:var(--accent); animation:blink 2s infinite">A_art</span> Planner
            </div>
            <nav>
                <button class="nav-link active" onclick="app.navigate('home')">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</button>
                <button class="nav-link" onclick="app.navigate('brain')">Ù…ØºØ² Ù…ØªÙÚ©Ø± ğŸ§ </button>
                <button class="nav-link" onclick="document.getElementById('settings-modal').showModal()">API Key</button>
            </nav>
        </div>
    </header>

    <main id="app-root" class="container"></main>

    <script>
        // --- ICONS & CONSTANTS ---
        const ICONS = {
            trash: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>',
            copy: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>',
            brain: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"></path><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"></path></svg>'
        };

        const TEMPLATES = {
            'AIDA': "Attention (ØªÙˆØ¬Ù‡) > Interest (Ø¹Ù„Ø§Ù‚Ù‡) > Desire (Ø§Ø´ØªÛŒØ§Ù‚) > Action (Ø§Ù‚Ø¯Ø§Ù…)",
            'PAS': "Problem (Ù…Ø´Ú©Ù„) > Agitation (ØªØ­Ø±ÛŒÚ© Ø¯Ø±Ø¯) > Solution (Ø±Ø§Ù‡â€ŒØ­Ù„ Ø´Ù…Ø§)",
            'FAB': "Features (ÙˆÛŒÚ˜Ú¯ÛŒ) > Advantages (Ù…Ø²ÛŒØª) > Benefits (Ø³ÙˆØ¯ Ù†Ù‡Ø§ÛŒÛŒ)",
            'STORY': "Hero (Ù‚Ù‡Ø±Ù…Ø§Ù†) > Conflict (Ù…Ø´Ú©Ù„) > Guide (Ø¨Ø±Ù†Ø¯ Ø´Ù…Ø§) > Success (Ù…ÙˆÙÙ‚ÛŒØª)"
        };

        class App {
            constructor() {
                this.state = {
                    view: 'home',
                    apiKey: localStorage.getItem('aart_apikey') || '',
                    projects: JSON.parse(localStorage.getItem('aart_projects') || '[]'),
                    brainDocs: JSON.parse(localStorage.getItem('aart_brain') || '[]'),
                    activeProjId: null,
                    wizardStep: 1,
                    wizardData: {},
                    isProcessingPdf: false
                };
                
                window.addEventListener('keydown', () => {
                    const blob = document.getElementById('aura-blob');
                    if(blob) {
                        blob.classList.add('aura-active');
                        clearTimeout(this.auraTimer);
                        this.auraTimer = setTimeout(() => blob.classList.remove('aura-active'), 150);
                    }
                });

                if(!this.state.apiKey) setTimeout(() => document.getElementById('settings-modal').showModal(), 1000);
                this.render();
            }

            /* --- STORAGE & UTILS --- */
            saveState() {
                localStorage.setItem('aart_projects', JSON.stringify(this.state.projects));
                localStorage.setItem('aart_brain', JSON.stringify(this.state.brainDocs));
            }

            saveSettings() {
                const k = document.getElementById('api-key-input').value.trim();
                if(k) {
                    this.state.apiKey = k;
                    localStorage.setItem('aart_apikey', k);
                    document.getElementById('settings-modal').close();
                    alert('Ú©Ù„ÛŒØ¯ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.');
                }
            }

            copyToClip(id) {
                const el = document.getElementById(id);
                if(el) { el.select(); document.execCommand('copy'); alert('Ú©Ù¾ÛŒ Ø´Ø¯!'); }
            }

            /* --- ROUTER --- */
            navigate(view, projId = null) {
                this.state.view = view;
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                
                if (view === 'home') {
                    document.querySelectorAll('.nav-link')[0].classList.add('active');
                    this.state.activeProjId = null;
                } else if (view === 'brain') {
                    document.querySelectorAll('.nav-link')[1].classList.add('active');
                } else if (view === 'wizard') {
                    this.state.activeProjId = projId;
                    const proj = this.state.projects.find(p => p.id === projId);
                    this.state.wizardData = { ...proj.data };
                    this.state.wizardStep = 1;
                }
                this.render();
            }

            /* --- RENDERER --- */
            render() {
                const root = document.getElementById('app-root');
                root.innerHTML = '';
                
                if (this.state.view === 'home') root.innerHTML = this.renderHome();
                else if (this.state.view === 'brain') root.innerHTML = this.renderBrain();
                else if (this.state.view === 'wizard') root.innerHTML = this.renderWizard();
            }

            /* --- HOME VIEW --- */
            renderHome() {
                return `
                    <div class="neon-wrapper active"><div class="card">
                        <h2>Ù¾Ø±ÙˆÚ˜Ù‡ Ø¬Ø¯ÛŒØ¯</h2>
                        <div class="grid-2" style="align-items:end">
                            <div><label>Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡</label><input type="text" id="new-p-name" placeholder="Ù…Ø«Ù„Ø§: Ú©Ù…Ù¾ÛŒÙ† Ø¨Ù„Ú© ÙØ±Ø§ÛŒØ¯ÛŒ"></div>
                            <div class="flex" style="gap:10px">
                                <div class="w-full"><label>Ù¾Ù„ØªÙØ±Ù…</label><select id="new-p-plat"><option>Instagram Post</option><option>Instagram Reel</option><option>Telegram</option><option>LinkedIn</option></select></div>
                                <button class="btn btn-primary" onclick="app.createProject()" style="height:48px; margin-top:24px">Ø³Ø§Ø®ØªÙ†</button>
                            </div>
                        </div>
                    </div></div>

                    <h3>Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø®ÛŒØ±</h3>
                    <div class="grid-3">
                        ${this.state.projects.length === 0 ? '<p>Ù„ÛŒØ³Øª Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.</p>' : ''}
                        ${this.state.projects.map(p => `
                            <div class="card" style="border:1px solid #333; cursor:pointer" onclick="app.navigate('wizard', '${p.id}')">
                                <div class="flex justify-between items-center">
                                    <strong style="color:var(--accent)">${p.name}</strong>
                                    <button class="btn" onclick="app.deleteProj('${p.id}', event)" style="padding:5px; border:none">${ICONS.trash}</button>
                                </div>
                                <div style="font-size:0.8rem; margin-top:5px; color:#666">${p.platform} | ${p.created}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            createProject() {
                const name = document.getElementById('new-p-name').value;
                if(!name) return alert('Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');
                const newP = {
                    id: Date.now().toString(),
                    name,
                    platform: document.getElementById('new-p-plat').value,
                    created: new Date().toLocaleDateString('fa-IR'),
                    data: {}
                };
                this.state.projects.unshift(newP);
                this.saveState();
                this.navigate('wizard', newP.id);
            }

            deleteProj(id, e) {
                e.stopPropagation();
                if(confirm('Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) {
                    this.state.projects = this.state.projects.filter(p => p.id !== id);
                    this.saveState();
                    this.render();
                }
            }

            /* --- BRAIN VIEW (UPDATED WITH PDF) --- */
            renderBrain() {
                return `
                    <div class="neon-wrapper active"><div class="card">
                        <h2>Ù…ØºØ² Ù…ØªÙÚ©Ø± (Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ù†Ø´)</h2>
                        <p>ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…ØªÙ†ÛŒ (txt, json) ÛŒØ§ <strong>PDF</strong> Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯. Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø§ÛŒÙ† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ø§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù†Ø¯.</p>
                        <div class="grid-2">
                            <div>
                                <label>Ø¹Ù†ÙˆØ§Ù† (Ù…Ø«Ù„Ø§: Ù„Ø­Ù† Ø¨Ø±Ù†Ø¯)</label><input type="text" id="br-title">
                                <label>Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ (PDF, TXT, JSON)</label>
                                <div style="position:relative">
                                    <input type="file" id="file-upload" onchange="app.handleFile(event)" accept=".txt,.json,.md,.pdf" style="padding-left:10px">
                                    ${this.state.isProcessingPdf ? '<div style="position:absolute; right:10px; top:12px; font-size:0.8rem; color:var(--accent)">Ø¯Ø±Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ PDF... <div class="spinner"></div></div>' : ''}
                                </div>
                            </div>
                            <div>
                                <label>Ù…Ø­ØªÙˆØ§</label><textarea id="br-content" rows="6" placeholder="Ù…ØªÙ† Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø´Ø¯Ù‡ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯..."></textarea>
                                <button class="btn btn-primary w-full" onclick="app.addBrainDoc()" ${this.state.isProcessingPdf ? 'disabled' : ''}>
                                    ${this.state.isProcessingPdf ? 'ØµØ¨Ø± Ú©Ù†ÛŒØ¯...' : 'Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ù…ØºØ²'}
                                </button>
                            </div>
                        </div>
                    </div></div>

                    <h3>Ù…Ù†Ø§Ø¨Ø¹ Ø¯Ø§Ù†Ø´ ÙØ¹Ø§Ù„ (${this.state.brainDocs.length})</h3>
                    <div class="grid-3">
                        ${this.state.brainDocs.map(d => `
                            <div class="card">
                                <div class="flex justify-between"><strong>${d.title}</strong><button class="btn" style="padding:2px" onclick="app.delBrain(${d.id})">${ICONS.trash}</button></div>
                                <p style="font-size:0.8rem; height:50px; overflow:hidden; margin-top:5px">${d.content.substring(0,60)}...</p>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            async handleFile(e) {
                const f = e.target.files[0];
                if (!f) return;

                // Set Title automatically
                if(!document.getElementById('br-title').value) {
                    document.getElementById('br-title').value = f.name;
                }

                // Handle PDF
                if (f.type === 'application/pdf') {
                    this.state.isProcessingPdf = true;
                    this.render(); // Update UI to show spinner
                    
                    try {
                        const arrayBuffer = await f.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                        let fullText = "";

                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            const pageText = textContent.items.map(item => item.str).join(' ');
                            fullText += `--- ØµÙØ­Ù‡ ${i} ---\n${pageText}\n\n`;
                        }

                        document.getElementById('br-content').value = fullText;
                    } catch (err) {
                        alert("Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† PDF: " + err.message);
                    } finally {
                        this.state.isProcessingPdf = false;
                        this.render();
                        // Restore values after re-render
                        document.getElementById('br-title').value = f.name;
                        document.getElementById('br-content').value = document.getElementById('br-content').defaultValue; 
                    }
                } 
                // Handle Text Files
                else {
                    const r = new FileReader();
                    r.onload = ev => {
                        document.getElementById('br-content').value = ev.target.result;
                    };
                    r.readAsText(f);
                }
            }

            addBrainDoc() {
                const t = document.getElementById('br-title').value;
                const c = document.getElementById('br-content').value;
                if(!t || !c) return alert('Ø¹Ù†ÙˆØ§Ù† Ùˆ Ù…Ø­ØªÙˆØ§ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');
                this.state.brainDocs.push({ id: Date.now(), title: t, content: c });
                this.saveState();
                this.render();
            }

            delBrain(id) {
                this.state.brainDocs = this.state.brainDocs.filter(d => d.id !== id);
                this.saveState();
                this.render();
            }

            /* --- WIZARD VIEW --- */
            renderWizard() {
                const p = this.state.projects.find(x => x.id === this.state.activeProjId);
                const s = this.state.wizardStep;
                const d = this.state.wizardData;
                
                const steps = ['Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ', 'Ù‚Ø§Ù„Ø¨', 'Ù…Ø­ØªÙˆØ§', 'Ø¢Ù†Ø§Ù„ÛŒØ²', 'Ú©Ù¾Ø´Ù†', 'Ø®Ø±ÙˆØ¬ÛŒ'];
                let content = '';
                
                if (s === 1) {
                    content = `
                        <h3>Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ùˆ Ù‡Ø¯Ù</h3>
                        <div class="grid-2">
                            <div><label>Ù‡Ø¯Ù Ø§ØµÙ„ÛŒ</label><select id="in-obj" onchange="app.setWData('obj', this.value)">
                                <option value="Awareness" ${d.obj=='Awareness'?'selected':''}>Ø¢Ú¯Ø§Ù‡ÛŒ (Awareness)</option>
                                <option value="Sales" ${d.obj=='Sales'?'selected':''}>ÙØ±ÙˆØ´ (Sales)</option>
                                <option value="Engagement" ${d.obj=='Engagement'?'selected':''}>ØªØ¹Ø§Ù…Ù„ (Engagement)</option>
                            </select></div>
                            <div><label>Ù…Ø®Ø§Ø·Ø¨ Ù‡Ø¯Ù</label><input type="text" value="${d.aud||''}" oninput="app.setWData('aud', this.value)"></div>
                        </div>
                        <label>Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ / Ø¢ÙØ± Ø§ØµÙ„ÛŒ</label><textarea rows="3" oninput="app.setWData('offer', this.value)">${d.offer||''}</textarea>
                    `;
                } else if (s === 2) {
                    const rec = d.obj === 'Sales' ? 'PAS' : (d.obj === 'Awareness' ? 'AIDA' : 'STORY');
                    if(!d.tmpl) this.state.wizardData.tmpl = rec;
                    content = `
                        <h3>Ø§Ù†ØªØ®Ø§Ø¨ Ù‚Ø§Ù„Ø¨</h3>
                        <div style="background:#111; padding:10px; border-radius:8px; margin-bottom:15px; border:1px dashed var(--accent)">
                            Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ: <strong style="color:var(--accent)">${rec}</strong>
                        </div>
                        <label>Ù‚Ø§Ù„Ø¨ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ</label>
                        <select id="in-tmpl" onchange="app.setWData('tmpl', this.value); document.getElementById('tmpl-info').innerText = TEMPLATES[this.value]">
                            ${Object.keys(TEMPLATES).map(k => `<option value="${k}" ${(d.tmpl||rec)==k?'selected':''}>${k}</option>`).join('')}
                        </select>
                        <p id="tmpl-info" class="mt-4">${TEMPLATES[d.tmpl||rec]}</p>
                    `;
                } else if (s === 3) {
                    content = `
                        <h3>Ù†Ú¯Ø§Ø±Ø´ Ù…Ø­ØªÙˆØ§</h3>
                        <div class="grid-2">
                            <div>
                                <label>Ù‡ÙˆÚ© (Ø´Ø±ÙˆØ¹ Ø¬Ø°Ø§Ø¨)</label><input value="${d.hook||''}" oninput="app.setWData('hook', this.value)">
                                <label>Ø¨Ø¯Ù†Ù‡ Ù…ØªÙ† (Ø³Ù†Ø§Ø±ÛŒÙˆ)</label><textarea rows="8" oninput="app.setWData('script', this.value)">${d.script||''}</textarea>
                            </div>
                            <div>
                                <label>ÙØ±Ø§Ø®ÙˆØ§Ù† (CTA)</label><input value="${d.cta||''}" oninput="app.setWData('cta', this.value)">
                                <label>ØªÙˆØ¶ÛŒØ­Ø§Øª Ø¨ØµØ±ÛŒ</label><textarea rows="4" oninput="app.setWData('visuals', this.value)">${d.visuals||''}</textarea>
                            </div>
                        </div>
                    `;
                } else if (s === 4) {
                    content = `
                        <h3>Ø¢Ù†Ø§Ù„ÛŒØ² Ù‡ÙˆØ´Ù…Ù†Ø¯</h3>
                        <p>Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ù…ØªÙ† Ø´Ù…Ø§ Ø±Ø§ Ù†Ù‚Ø¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.</p>
                        <button class="btn btn-primary w-full" id="btn-analyze" onclick="app.runAnalysis()">Ø´Ø±ÙˆØ¹ Ø¢Ù†Ø§Ù„ÛŒØ²</button>
                        <div id="res-analyze" class="mt-4 card" style="display:${d.analysisResult ? 'block' : 'none'}">${d.analysisResult||''}</div>
                    `;
                } else if (s === 5) {
                    content = `
                        <h3>Ú©Ù¾Ø´Ù† Ùˆ Ù‡Ø´ØªÚ¯</h3>
                        <div class="grid-3">
                            <div><label>Ù„Ø­Ù†</label><select id="c-tone"><option>Friendly</option><option>Professional</option><option>Bold</option></select></div>
                            <div><label>Ø²Ø¨Ø§Ù†</label><select id="c-lang"><option>Persian</option><option>English</option></select></div>
                            <div><label>Ø·ÙˆÙ„</label><select id="c-len"><option>Medium</option><option>Short</option><option>Long</option></select></div>
                        </div>
                        <button class="btn btn-primary w-full mt-4" id="btn-caption" onclick="app.runCaption()">ØªÙˆÙ„ÛŒØ¯ Ú©Ù¾Ø´Ù†</button>
                        <div class="grid-2 mt-4">
                            <div><label>Ú©Ù¾Ø´Ù†</label><textarea id="out-cap" rows="6" oninput="app.setWData('finalCap', this.value)">${d.finalCap||''}</textarea></div>
                            <div><label>Ù‡Ø´ØªÚ¯</label><textarea id="out-tag" rows="6" class="font-en" oninput="app.setWData('finalTags', this.value)">${d.finalTags||''}</textarea></div>
                        </div>
                    `;
                } else if (s === 6) {
                    const checks = d.checklist || {hook:'off', benefit:'off', cta:'off', tone:'off'};
                    content = `
                        <h3>Ø®Ø±ÙˆØ¬ÛŒ Ù†Ù‡Ø§ÛŒÛŒ</h3>
                        <div class="grid-2">
                            <div>
                                <h4>Ù…ØªÙ† Ù†Ù‡Ø§ÛŒÛŒ</h4>
                                <div style="background:#111; padding:15px; border-radius:8px; white-space:pre-wrap; font-size:0.9rem">${d.script}</div>
                            </div>
                            <div>
                                <div class="flex justify-between items-center"><h4>Ú†Ú©â€ŒÙ„ÛŒØ³Øª Ú©ÛŒÙÛŒ</h4><button class="btn" id="btn-check" onclick="app.runChecklist()">Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¬Ø¯Ø¯</button></div>
                                <div class="mt-4">
                                    <div class="check-row"><span>Ù‡ÙˆÚ©</span><div class="light ${checks.hook}"></div></div>
                                    <div class="check-row"><span>Ù…Ø²ÛŒØª</span><div class="light ${checks.benefit}"></div></div>
                                    <div class="check-row"><span>CTA</span><div class="light ${checks.cta}"></div></div>
                                    <div class="check-row"><span>Ù„Ø­Ù†</span><div class="light ${checks.tone}"></div></div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                return `
                    <div class="flex justify-between items-center mb-4">
                        <h2 style="margin:0">${p.name} <span style="font-size:0.8rem; color:var(--accent)">(${p.platform})</span></h2>
                        <button class="btn" onclick="app.navigate('home')">Ø®Ø±ÙˆØ¬</button>
                    </div>
                    <div class="steps-bar">${steps.map((l, i) => `<div class="step-dot ${i+1===s?'active':''}">${i+1}. ${l}</div>`).join('')}</div>
                    <div class="card" style="min-height:400px">${content}</div>
                    <div class="flex justify-between mt-4">
                        <button class="btn" onclick="app.changeStep(-1)" ${s===1?'disabled':''}>Ù…Ø±Ø­Ù„Ù‡ Ù‚Ø¨Ù„</button>
                        <button class="btn btn-primary" onclick="app.changeStep(1)">${s===6?'Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ù¾Ø§ÛŒØ§Ù†':'Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯'}</button>
                    </div>
                `;
            }

            /* --- WIZARD LOGIC --- */
            setWData(key, val) { this.state.wizardData[key] = val; }

            changeStep(dir) {
                const newStep = this.state.wizardStep + dir;
                if (newStep > 6) {
                    const pIndex = this.state.projects.findIndex(p => p.id === this.state.activeProjId);
                    this.state.projects[pIndex].data = { ...this.state.wizardData };
                    this.saveState();
                    alert('Ù¾Ø±ÙˆÚ˜Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.');
                    this.navigate('home');
                } else if (newStep >= 1) {
                    this.state.wizardStep = newStep;
                    this.render();
                }
            }

            /* --- AI ENGINE --- */
            async callAI(userPrompt) {
                if(!this.state.apiKey) return "MOCK";
                let context = "";
                if(this.state.brainDocs.length > 0) {
                    context = "CONTEXT (Use this knowledge base):\n" + 
                              this.state.brainDocs.map(d => `- ${d.title}: ${d.content}`).join('\n') + 
                              "\n----------------\n";
                }
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${this.state.apiKey}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: context + userPrompt }] }] })
                    });
                    const data = await res.json();
                    if(data.error) throw new Error(data.error.message);
                    return data.candidates[0].content.parts[0].text;
                } catch(e) { alert("AI Error: " + e.message); return null; }
            }

            extractJSON(text) {
                const match = text.match(/\{[\s\S]*\}|\[[\s\S]*\]/);
                return match ? match[0] : text;
            }

            async runAnalysis() {
                const btn = document.getElementById('btn-analyze');
                const box = document.getElementById('res-analyze');
                const d = this.state.wizardData;
                btn.innerText = 'Ø¯Ø±Ø­Ø§Ù„ ØªØ­Ù„ÛŒÙ„...'; btn.disabled = true;
                
                const prompt = `Act as an Ad Auditor. Language: Persian.
                Analyze this script based on: Objective: ${d.obj}, Target: ${d.aud}, Script: "${d.hook} ${d.script} ${d.cta}".
                Return HTML ONLY: <ul style="padding-right:20px"><li style="color:#0f0"><strong>Strengths:</strong> ...</li><li style="color:#f00"><strong>Weaknesses:</strong> ...</li><li style="color:#CCFF00"><strong>Improvement:</strong> ...</li></ul>`;

                let res = await this.callAI(prompt);
                if(res === "MOCK") res = "<ul><li style='color:orange'>Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ† ÙØ¹Ø§Ù„ Ø§Ø³Øª.</li></ul>";
                else if(res) res = res.replace(/```html/g,'').replace(/```/g,'');

                this.setWData('analysisResult', res);
                box.innerHTML = res; box.style.display = 'block';
                btn.innerText = 'Ø´Ø±ÙˆØ¹ Ø¢Ù†Ø§Ù„ÛŒØ²'; btn.disabled = false;
            }

            async runCaption() {
                const btn = document.getElementById('btn-caption');
                const d = this.state.wizardData;
                const tone = document.getElementById('c-tone').value;
                btn.innerText = '...'; btn.disabled = true;

                const prompt = `Write caption. Lang: ${document.getElementById('c-lang').value}. Tone: ${tone}. Context: ${d.script}. Offer: ${d.offer}. Return JSON ONLY: {"caption":"...","hashtags":"..."}`;
                let res = await this.callAI(prompt);
                let json = {caption: "Error", hashtags: ""};
                if(res === "MOCK") json = {caption: "Ø¢ÙÙ„Ø§ÛŒÙ†...", hashtags: "#ØªØ³Øª"};
                else if(res) { try { json = JSON.parse(this.extractJSON(res)); } catch(e) { console.error(e); } }

                this.setWData('finalCap', json.caption);
                this.setWData('finalTags', json.hashtags);
                this.render();
            }

            async runChecklist() {
                const btn = document.getElementById('btn-check');
                const d = this.state.wizardData;
                btn.innerText = '...'; btn.disabled = true;

                const prompt = `Check ad quality. Script: ${d.script}. Criteria: Hook, Benefit, CTA, Tone. Return JSON array of 4 strings (green, yellow, red).`;
                let res = await this.callAI(prompt);
                let arr = ["green", "green", "green", "green"];
                if(res !== "MOCK" && res) { try { arr = JSON.parse(this.extractJSON(res)); } catch(e) {} }

                const newChecks = { hook: arr[0], benefit: arr[1], cta: arr[2], tone: arr[3] };
                this.setWData('checklist', newChecks);
                this.render();
            }
        }

        const app = new App();
    </script>
</body>
</html>